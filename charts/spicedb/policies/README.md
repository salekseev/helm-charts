# OPA/Conftest Policies for SpiceDB Helm Chart

This directory contains Open Policy Agent (OPA) policies written in Rego for validating Kubernetes manifests generated by the SpiceDB Helm chart.

## Installation

### Install Conftest

**Linux:**

```bash
curl -L https://github.com/open-policy-agent/conftest/releases/download/v0.56.0/conftest_0.56.0_Linux_x86_64.tar.gz | tar xz
sudo mv conftest /usr/local/bin/
```

**macOS:**

```bash
brew install conftest
```

**Verify installation:**

```bash
conftest --version
```

## Usage

### Test rendered Helm templates

```bash
# From the chart directory
cd charts/spicedb

# Test with default values
helm template . | conftest test -

# Test with custom values
helm template . --values values.yaml | conftest test -

# Test with specific policy namespace
conftest test -p policies/ <(helm template .)
```

### Test individual manifest files

```bash
conftest test -p policies/ path/to/deployment.yaml
```

## Policies

See [policy-metadata.yaml](policy-metadata.yaml) for detailed documentation of each policy.

### Deny Policies (will cause failure)

- **deny-privileged-containers**: Prevents privileged container mode
- **deny-latest-tag**: Prevents use of ':latest' image tag
- **deny-no-tag**: Requires explicit image tags
- **deny-missing-resource-limits**: Requires resource limits
- **deny-missing-resource-requests**: Requires resource requests
- **deny-run-as-root**: Requires runAsNonRoot: true
- **deny-writable-root-filesystem**: Requires readOnlyRootFilesystem: true
- **deny-dangerous-capabilities**: Prevents dangerous Linux capabilities

### Warn Policies (advisory only)

- **warn-missing-liveness-probe**: Recommends liveness probes
- **warn-missing-readiness-probe**: Recommends readiness probes
- **warn-missing-recommended-labels**: Recommends Kubernetes standard labels
- **warn-host-network**: Warns about host network usage
- **warn-host-pid**: Warns about host PID namespace usage

## Testing Policies

Test the policies themselves using example manifests:

```bash
# Test with a compliant manifest
conftest test -p policies/ examples/compliant-deployment.yaml

# Test with a non-compliant manifest
conftest test -p policies/ examples/non-compliant-deployment.yaml
```

## CI/CD Integration

These policies are automatically enforced in the CI/CD pipeline. See `.github/workflows/ci.yaml` for configuration.
