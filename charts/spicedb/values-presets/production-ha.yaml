# High Availability: HPA (2-5 replicas), PDB, pod anti-affinity, topology spread constraints
# Prerequisites: multi-zone K8s cluster, Metrics Server, sufficient capacity, base production preset (see README)
# Usage: helm install NAME . -f values-presets/production-postgres.yaml -f values-presets/production-ha.yaml --set config.existingSecret=SECRET

replicaCount: 2

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

podDisruptionBudget:
  enabled: true
  maxUnavailable: 1

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          topologyKey: topology.kubernetes.io/zone
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: spicedb

topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: spicedb
