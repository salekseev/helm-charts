# Default values for spicedb.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Number of SpiceDB replicas (use 3+ for production HA)
replicaCount: 2

image:
  repository: authzed/spicedb
  pullPolicy: IfNotPresent
  tag: ""  # Overrides chart appVersion

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  automount: true
  # Cloud workload identity annotations (see examples/cloud-workload-identity.yaml)
  annotations: {}
  name: ""

rbac:
  create: true

podAnnotations: {}
podLabels: {}

# Graceful shutdown ensures in-flight requests complete before termination
terminationGracePeriodSeconds: 60

# Pod Security Standards restricted profile
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

# Container-level security context (least privilege)
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true

service:
  type: ClusterIP
  # Headless service for StatefulSet (creates clusterIP: None for pod-to-pod communication)
  headless: false
  grpcPort: 50051
  httpPort: 8443
  metricsPort: 9090
  dispatchPort: 50053

# Resource limits (adjust based on workload)
resources:
  requests:
    cpu: 500m
    memory: 1Gi
  limits:
    cpu: 2000m
    memory: 4Gi

# Rolling update for zero-downtime deployments
updateStrategy:
  rollingUpdate:
    maxUnavailable: 0  # Ensures at least one pod always available
    maxSurge: 1  # One extra pod during updates

# Health probes (gRPC health checks for Kubernetes 1.23+)
probes:
  startup:
    enabled: true
    initialDelaySeconds: 0
    periodSeconds: 5
    timeoutSeconds: 3
    successThreshold: 1
    failureThreshold: 30  # 150s total startup time

  liveness:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3  # 30s before restart

  readiness:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    successThreshold: 1
    failureThreshold: 2  # 10s before marking unready

# PodDisruptionBudget protects against maintenance operations
podDisruptionBudget:
  enabled: false
  maxUnavailable: 1

# HPA (requires metrics-server, overrides replicaCount when enabled)
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

logging:
  level: info  # Valid: debug, info, warn, error
  format: json  # Valid: json, console

# Config for SpiceDB

# Operator-style simplified configuration (overrides config section when enabled)
operatorStyle:
  enabled: false

  # Reference to existing secret with preshared-key and datastore-uri keys
  secretName: ""

  # Overrides replicaCount when enabled
  replicas: 3

  # Single TLS secret for all endpoints (gRPC, HTTP, dispatch)
  tlsSecretName: ""

  # CA cert secret for verifying upstream dispatch connections
  dispatchUpstreamCASecretName: ""

  # Valid: postgres, cockroachdb, memory
  datastoreEngine: postgres


config:
  # Valid: memory, postgres, cockroachdb
  datastoreEngine: memory

  presharedKey: "insecure-default-key-change-in-production"

  # Auto-generate secure random key on install (requires opt-in)
  autogenerateSecret: false

  # Use existing secret instead of creating one
  existingSecret: ""

  # Explicit connection URI (overrides generated string)
  datastoreURI: ""

  # Connection config (used when datastoreURI not set)
  datastore:
    hostname: "localhost"
    port: 5432
    username: "spicedb"
    password: ""
    database: "spicedb"
    sslMode: "disable"  # postgres: disable|allow|prefer|require|verify-ca|verify-full
    sslRootCert: ""
    sslCert: ""
    sslKey: ""

# TLS configuration for SpiceDB endpoints
tls:
  enabled: false

  # gRPC endpoint TLS (client-to-SpiceDB)
  grpc:
    secretName: ""  # Secret with tls.crt, tls.key, ca.crt
    certPath: /etc/spicedb/tls/grpc/tls.crt
    keyPath: /etc/spicedb/tls/grpc/tls.key
    caPath: /etc/spicedb/tls/grpc/ca.crt

  # HTTP endpoint TLS (dashboard and metrics)
  http:
    secretName: ""  # Secret with tls.crt, tls.key
    certPath: /etc/spicedb/tls/http/tls.crt
    keyPath: /etc/spicedb/tls/http/tls.key

  # Dispatch cluster mTLS (inter-node communication)
  dispatch:
    secretName: ""  # Secret with tls.crt, tls.key, ca.crt
    certPath: /etc/spicedb/tls/dispatch/tls.crt
    keyPath: /etc/spicedb/tls/dispatch/tls.key
    caPath: /etc/spicedb/tls/dispatch/ca.crt

  # Datastore TLS (database connections)
  datastore:
    secretName: ""  # Secret with ca.crt, tls.crt (optional), tls.key (optional)
    caPath: /etc/spicedb/tls/datastore/ca.crt

# Dispatch cluster distributes permission checks across pods
dispatch:
  # Automatically disabled for memory datastore
  enabled: true

  # Secret with ca.crt for verifying upstream SpiceDB instances
  upstreamCASecretName: ""
  upstreamCAPath: /etc/dispatch-ca/ca.crt

  # Cluster identifier for logging/metrics
  clusterName: ""

# Database migrations
migrations:
  # Run migrations as pre-install/pre-upgrade Job
  enabled: true

  logLevel: debug  # Valid: debug, info, warn, error

  # Target specific migration version (optional)
  targetMigration: ""

  # Target specific phase (optional). Valid: write, read, complete
  targetPhase: ""

  # Track migration state for observability
  tracking:
    enabled: true

  # Pre-upgrade validation prevents issues
  validation:
    enabled: true

  resources: {}

  cleanup:
    enabled: false

monitoring:
  # Prometheus scraping annotations
  enabled: true

  # ServiceMonitor (requires Prometheus Operator CRDs)
  serviceMonitor:
    enabled: false
    interval: 30s
    scrapeTimeout: 10s
    labels: {}  # Metadata labels for ServiceMonitor resource
    additionalLabels: {}  # Labels for Prometheus to discover this ServiceMonitor
    path: /metrics

# Ingress configuration (see examples/ingress-examples.yaml for complete examples)
ingress:
  enabled: false
  className: ""  # Valid: nginx, contour, traefik
  annotations: {}
  hosts: []  # Available ports: grpc (50051), http (8443), metrics (9090), dispatch (50053)
  tls: []

nodeSelector: {}

tolerations: []

affinity: {}

# Operator compatibility annotations for version tracking
operatorCompatibility:
  enabled: false
  annotations:
    version: true
    chartVersion: true
    datastoreEngine: true
    migrationHash: true

# NetworkPolicy for zero-trust network isolation
networkPolicy:
  # Requires network plugin supporting NetworkPolicy (Calico, Cilium)
  enabled: false

  # Ingress controller namespace selector
  ingressControllerNamespaceSelector: {}

  # Prometheus namespace selector
  prometheusNamespaceSelector: {}

  # Database egress (auto-configured based on datastoreEngine if not set)
  databaseEgress: {}

  # Custom ingress rules
  ingress: []

  # Custom egress rules
  egress: []

# Strategic merge patches (see examples/patches-examples.yaml)
patches:
  deployment: []
  service: []
  ingress: []
