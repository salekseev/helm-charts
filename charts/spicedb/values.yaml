# Default values for spicedb.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

replicaCount: 1

image:
  repository: authzed/spicedb
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: ""

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Automatically mount a ServiceAccount's API credentials?
  automount: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

rbac:
  # Specifies whether RBAC resources should be created
  create: true

podAnnotations: {}
podLabels: {}

# Pod-level security context
# Implements Kubernetes Pod Security Standards restricted profile
# These settings apply to all containers in the pod
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

# Container-level security context
# Additional security restrictions for the SpiceDB container
# Implements least privilege and defense in depth
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true

service:
  type: ClusterIP
  # Headless service configuration for StatefulSet deployments
  # When enabled, creates a headless service (clusterIP: None) that provides stable
  # network identities for individual pods. This is required for StatefulSet deployments
  # and enables direct pod-to-pod communication for features like dispatch clustering.
  # Note: Setting this to true overrides the service type and creates a headless service
  # regardless of the 'type' setting above.
  # Default: false (creates standard ClusterIP service)
  headless: false
  grpcPort: 50051
  httpPort: 8443
  metricsPort: 9090
  dispatchPort: 50053

# Resource limits and requests for SpiceDB containers
# Defaults are set for production workloads
# Adjust based on your workload and cluster capacity
resources:
  requests:
    cpu: 500m
    memory: 1Gi
  limits:
    cpu: 2000m
    memory: 4Gi

# Rolling update strategy for zero-downtime deployments
# These settings ensure high availability during updates
updateStrategy:
  rollingUpdate:
    # Maximum number of pods that can be unavailable during update
    # 0 ensures at least one pod is always available
    maxUnavailable: 0
    # Maximum number of pods that can be created above desired replicas
    # 1 allows one extra pod during updates to maintain availability
    maxSurge: 1

# PodDisruptionBudget ensures availability during voluntary disruptions
# Automatically enabled when replicaCount > 1, or can be explicitly enabled
podDisruptionBudget:
  # Explicitly enable PDB (auto-enables when replicaCount > 1)
  enabled: false
  # Maximum number of unavailable pods during disruption
  # With 3 replicas and maxUnavailable=1, at least 2 pods remain running
  maxUnavailable: 1

# HorizontalPodAutoscaler for automatic scaling based on resource utilization
# Note: When enabled, HPA manages replica count (ignores replicaCount setting)
# Requires metrics-server to be installed in the cluster
autoscaling:
  # Enable horizontal pod autoscaling
  enabled: false
  # Minimum number of replicas (should be >= 2 for HA)
  minReplicas: 2
  # Maximum number of replicas
  maxReplicas: 10
  # Target CPU utilization percentage for scaling
  targetCPUUtilizationPercentage: 80
  # Target memory utilization percentage for scaling
  targetMemoryUtilizationPercentage: 80

# Logging configuration
# Controls log verbosity and format for SpiceDB and migration jobs
logging:
  # Log level controls verbosity of logs
  # Valid values: debug, info, warn, error
  # debug: Verbose logging for troubleshooting
  # info: Standard operational logging (recommended for production)
  # warn: Only warnings and errors
  # error: Only errors
  level: info

  # Log format controls output structure
  # Valid values: json, console
  # json: Structured JSON logging (recommended for production, log aggregation)
  # console: Human-readable console output (useful for development)
  format: json

# Config for SpiceDB
config:
  # Datastore engine: memory, postgres, cockroachdb
  datastoreEngine: memory

  # gRPC preshared key for authentication
  # This is required for SpiceDB to start
  # In production, this should be set via an existing secret
  presharedKey: "insecure-default-key-change-in-production"

  # Reference to an existing secret containing datastore credentials
  # If set, the chart will not create a secret and will use this instead
  # The secret must contain a 'datastore-uri' key with the connection string
  existingSecret: ""

  # Explicit datastore connection URI (overrides generated connection string)
  # Format for PostgreSQL: postgresql://user:password@host:port/database?sslmode=disable
  # Format for CockroachDB: postgresql://user:password@host:port/database?sslmode=verify-full
  datastoreURI: ""

  # Datastore connection configuration (used when datastoreURI is not set)
  datastore:
    # Hostname of the database server
    hostname: "localhost"

    # Port number (default: 5432 for postgres, 26257 for cockroachdb)
    port: 5432

    # Database username
    username: "spicedb"

    # Database password (only used if existingSecret is not set)
    password: ""

    # Database name
    database: "spicedb"

    # SSL mode for database connections
    # For PostgreSQL: disable, allow, prefer, require, verify-ca, verify-full
    # For CockroachDB: require, verify-ca, verify-full (verify-full recommended)
    sslMode: "disable"

    # Path to SSL root certificate (optional)
    sslRootCert: ""

    # Path to SSL client certificate (optional)
    sslCert: ""

    # Path to SSL client key (optional)
    sslKey: ""

# TLS configuration for SpiceDB endpoints
# SpiceDB supports TLS for multiple endpoints to secure communication
tls:
  # Master switch to enable TLS features
  # When disabled, all TLS configurations below are ignored
  # Set to true to enable TLS on any endpoint
  enabled: false

  # gRPC endpoint TLS configuration
  # The gRPC endpoint is the primary API for clients interacting with SpiceDB
  # This configures server-side TLS for securing client-to-SpiceDB communication
  grpc:
    # Name of the Kubernetes secret containing TLS certificates
    # The secret should contain the following keys:
    #   - tls.crt: Server certificate
    #   - tls.key: Server private key
    #   - ca.crt: CA certificate (optional, for client certificate verification)
    #
    # Example using cert-manager:
    #   apiVersion: cert-manager.io/v1
    #   kind: Certificate
    #   metadata:
    #     name: spicedb-grpc-tls
    #   spec:
    #     secretName: spicedb-grpc-tls
    #     dnsNames:
    #       - spicedb.example.com
    #     issuerRef:
    #       name: my-issuer
    secretName: ""

    # Path where the server certificate will be mounted in the container
    certPath: /etc/spicedb/tls/grpc/tls.crt

    # Path where the server private key will be mounted in the container
    keyPath: /etc/spicedb/tls/grpc/tls.key

    # Path where the CA certificate will be mounted in the container
    # Used for verifying client certificates if mTLS is required
    caPath: /etc/spicedb/tls/grpc/ca.crt

  # HTTP endpoint TLS configuration
  # The HTTP endpoint provides the dashboard and metrics
  # This configures server-side TLS for securing HTTP communication
  http:
    # Name of the Kubernetes secret containing TLS certificates
    # The secret should contain the following keys:
    #   - tls.crt: Server certificate
    #   - tls.key: Server private key
    #
    # You can reuse the same secret as gRPC if the certificate is valid for both
    # or create a separate secret for different certificate requirements
    secretName: ""

    # Path where the server certificate will be mounted in the container
    certPath: /etc/spicedb/tls/http/tls.crt

    # Path where the server private key will be mounted in the container
    keyPath: /etc/spicedb/tls/http/tls.key

  # Dispatch cluster TLS configuration (mTLS)
  # The dispatch endpoint is used for internal cluster communication between SpiceDB nodes
  # This configures mutual TLS (mTLS) where both client and server verify each other
  # mTLS is strongly recommended for dispatch to prevent unauthorized nodes from joining
  dispatch:
    # Name of the Kubernetes secret containing TLS certificates for dispatch
    # The secret should contain the following keys:
    #   - tls.crt: Certificate for this SpiceDB instance (both server and client)
    #   - tls.key: Private key for this SpiceDB instance
    #   - ca.crt: CA certificate to verify other SpiceDB instances
    #
    # Important: All SpiceDB instances in the cluster must share the same CA
    # Each instance should have its own certificate signed by that CA
    #
    # Example using cert-manager with a shared CA:
    #   apiVersion: cert-manager.io/v1
    #   kind: Certificate
    #   metadata:
    #     name: spicedb-dispatch-tls
    #   spec:
    #     secretName: spicedb-dispatch-tls
    #     commonName: spicedb-dispatch
    #     usages:
    #       - server auth
    #       - client auth
    #     issuerRef:
    #       name: spicedb-ca-issuer
    secretName: ""

    # Path where the dispatch certificate will be mounted in the container
    certPath: /etc/spicedb/tls/dispatch/tls.crt

    # Path where the dispatch private key will be mounted in the container
    keyPath: /etc/spicedb/tls/dispatch/tls.key

    # Path where the dispatch CA certificate will be mounted in the container
    # Used to verify certificates from other SpiceDB instances in the cluster
    caPath: /etc/spicedb/tls/dispatch/ca.crt

  # Datastore TLS configuration
  # Configures TLS for connections to the database backend
  # Note: Connection URI and SSL parameters in config.datastore take precedence
  # This section provides an alternative way to configure datastore TLS via secrets
  datastore:
    # Name of the Kubernetes secret containing datastore TLS certificates
    # The secret should contain the following keys:
    #   - ca.crt: CA certificate to verify the database server
    #   - tls.crt: Client certificate (optional, for mTLS)
    #   - tls.key: Client private key (optional, for mTLS)
    #
    # This is useful when the database requires client certificate authentication
    # or when you want to manage certificates separately from the datastore URI
    #
    # For PostgreSQL, set config.datastore.sslMode to "verify-ca" or "verify-full"
    # For CockroachDB, set config.datastore.sslMode to "verify-full"
    secretName: ""

    # Path where the datastore CA certificate will be mounted in the container
    # This path should match config.datastore.sslRootCert if using URI configuration
    caPath: /etc/spicedb/tls/datastore/ca.crt

# Dispatch cluster mode configuration
# Enables distributed permission checking across multiple SpiceDB instances
# When enabled, SpiceDB instances can communicate with each other to distribute
# permission checks across the cluster for improved performance
dispatch:
  # Enable dispatch cluster mode
  # When true, enables distributed permission checking between SpiceDB pods
  # Requires multiple replicas to be effective (replicaCount > 1)
  enabled: false

  # Name of the Kubernetes secret containing custom CA certificate for upstream dispatch connections
  # The secret should contain the following key:
  #   - ca.crt: CA certificate to verify upstream SpiceDB instances
  #
  # This is useful when upstream SpiceDB instances use certificates signed by a custom CA
  # Leave empty to use system default CA certificates
  #
  # Note: This is different from tls.dispatch which configures mTLS for the dispatch endpoint
  # upstreamCASecretName configures the CA used to verify connections TO other instances
  # tls.dispatch configures the certificates used BY this instance for its dispatch endpoint
  upstreamCASecretName: ""

  # Path where the upstream CA certificate will be mounted in the container
  # Used by SPICEDB_DISPATCH_UPSTREAM_CA_CERT_PATH environment variable
  upstreamCAPath: /etc/dispatch-ca/ca.crt

  # Cluster name for identifying this SpiceDB cluster
  # Optional: Used for logging and metrics to distinguish between multiple clusters
  clusterName: ""

# Database migration configuration
migrations:
  # Specifies whether to run database migrations as a pre-install/pre-upgrade Job
  # When enabled, migrations will run automatically before SpiceDB starts
  # Disable this if you want to manage migrations separately
  enabled: true

  # Log level for migration operations
  # Valid values: debug, info, warn, error
  # Use 'debug' for troubleshooting migration issues
  logLevel: info

  # Target a specific migration version (optional)
  # Leave empty to migrate to the latest version
  # Format: migration version identifier (e.g., "add-caveats")
  # Useful for rolling back or testing specific migration states
  targetMigration: ""

  # Target a specific migration phase (optional)
  # Valid values: write, read, complete
  # Phases allow for zero-downtime migrations:
  #   - write: Make schema changes, old code still works
  #   - read: New code can read new schema, old code deprecated
  #   - complete: Migration fully complete, old code support removed
  # Leave empty to run all phases
  targetPhase: ""

  # Resource limits and requests for the migration Job
  # These are independent from the main SpiceDB deployment resources
  # Migrations may need more resources for large schema changes
  resources: {}
    # limits:
    #   cpu: 500m
    #   memory: 512Mi
    # requests:
    #   cpu: 100m
    #   memory: 128Mi

  # Cleanup configuration for migration jobs
  cleanup:
    # Enable automatic cleanup of completed migration jobs
    enabled: false

# Monitoring configuration
monitoring:
  # Enable Prometheus metrics scraping annotations
  # When enabled, adds prometheus.io/* annotations to pod template
  enabled: true

  # Prometheus Operator ServiceMonitor configuration
  # Requires Prometheus Operator CRDs (monitoring.coreos.com/v1) to be installed in the cluster
  # The ServiceMonitor CRD allows Prometheus to automatically discover and scrape metrics
  serviceMonitor:
    # Specifies whether a ServiceMonitor should be created
    # Set to true to enable Prometheus metrics scraping via ServiceMonitor
    enabled: false

    # Scrape interval for Prometheus metrics
    # Defines how often Prometheus scrapes the metrics endpoint
    # Default: 30s (30 seconds)
    interval: 30s

    # Scrape timeout for Prometheus metrics
    # Maximum time to wait for a metrics scrape to complete
    # Must be less than the scrape interval
    # Default: 10s (10 seconds)
    scrapeTimeout: 10s

    # Additional metadata labels for the ServiceMonitor resource
    # These labels are added to the ServiceMonitor metadata only
    # They do not affect Prometheus discovery or scraping
    # Use for organizational purposes, ownership, or cost tracking
    #
    # Example usage:
    #   labels:
    #     team: security
    #     component: authorization
    #     environment: production
    labels: {}

    # Additional labels for Prometheus ServiceMonitor selection
    # These labels are used by Prometheus to discover ServiceMonitors
    # Must match the serviceMonitorSelector in your Prometheus CR
    #
    # Common examples:
    #   release: prometheus-operator  # For Prometheus Operator chart
    #   prometheus: kube-prometheus    # For kube-prometheus-stack
    #   app.kubernetes.io/part-of: monitoring
    #
    # Example usage:
    #   additionalLabels:
    #     prometheus: kube-prometheus
    #     team: platform
    additionalLabels: {}

    # Metrics path to scrape
    # SpiceDB exposes metrics on the standard /metrics endpoint
    # Default: /metrics
    path: /metrics

nodeSelector: {}

tolerations: []

affinity: {}
