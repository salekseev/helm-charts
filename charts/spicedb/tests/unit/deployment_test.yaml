suite: test deployment
templates:
  - deployment.yaml
tests:
  # Basic rendering tests
  - it: should render a Deployment
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: apiVersion
          value: apps/v1

  - it: should have correct metadata
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-spicedb
      - isNotEmpty:
          path: metadata.labels
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: spicedb
      - equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm

  # Replica count tests
  - it: should set default replica count to 2 (operator parity)
    asserts:
      - equal:
          path: spec.replicas
          value: 2

  - it: should allow custom replica count
    set:
      replicaCount: 5
    asserts:
      - equal:
          path: spec.replicas
          value: 5

  # Image configuration tests
  - it: should use default image repository and tag
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^authzed/spicedb:v

  - it: should allow custom image repository
    set:
      image.repository: custom/spicedb
      image.tag: custom-tag
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: custom/spicedb:custom-tag

  - it: should set image pull policy
    set:
      image.pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always

  # Container configuration tests
  - it: should have correct container name
    asserts:
      - equal:
          path: spec.template.spec.containers[0].name
          value: spicedb

  - it: should expose all required ports
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: grpc
            containerPort: 50051
            protocol: TCP
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: http
            containerPort: 8443
            protocol: TCP
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: metrics
            containerPort: 9090
            protocol: TCP
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: dispatch
            containerPort: 50053
            protocol: TCP

  # Environment variables tests
  - it: should set datastore engine to memory by default
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DATASTORE_ENGINE
            value: memory

  - it: should set log level from values
    set:
      logging.level: debug
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_LOG_LEVEL
            value: debug

  # Datastore connection tests
  - it: should set postgres datastore engine and connection URI from secret
    set:
      config.datastoreEngine: postgres
      config.datastore.hostname: postgres.example.com
      config.datastore.username: testuser
      config.datastore.password: testpass
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DATASTORE_ENGINE
            value: postgres
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DATASTORE_CONN_URI
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-spicedb
                key: datastore-uri

  - it: should set cockroachdb datastore engine and connection URI from secret
    set:
      config.datastoreEngine: cockroachdb
      config.datastore.hostname: cockroachdb.example.com
      config.datastore.username: spicedb
      config.datastore.password: secretpass
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DATASTORE_ENGINE
            value: cockroachdb
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DATASTORE_CONN_URI
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-spicedb
                key: datastore-uri

  - it: should use existingSecret when provided
    set:
      config.datastoreEngine: postgres
      config.existingSecret: my-external-secret
      config.datastore.hostname: postgres.example.com
      config.datastore.username: testuser
      config.datastore.password: testpass
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DATASTORE_CONN_URI
            valueFrom:
              secretKeyRef:
                name: my-external-secret
                key: datastore-uri

  - it: should not set connection URI for memory datastore
    set:
      config.datastoreEngine: memory
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DATASTORE_ENGINE
            value: memory
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DATASTORE_CONN_URI

  # Resource configuration tests
  - it: should set default resources
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 1Gi
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 2000m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 4Gi

  - it: should set resource limits when provided
    set:
      resources.limits.cpu: 1000m
      resources.limits.memory: 2Gi
      resources.requests.cpu: 500m
      resources.requests.memory: 1Gi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 1000m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 2Gi
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 1Gi

  # Security context tests
  - it: should set default security context
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop[0]
          value: ALL

  - it: should set security context when provided
    set:
      securityContext.runAsNonRoot: true
      securityContext.runAsUser: 1000
      securityContext.readOnlyRootFilesystem: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 1000
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true

  # Pod labels and annotations tests
  - it: should add custom pod labels
    set:
      podLabels.environment: production
      podLabels.team: platform
    asserts:
      - equal:
          path: spec.template.metadata.labels.environment
          value: production
      - equal:
          path: spec.template.metadata.labels.team
          value: platform

  - it: should add custom pod annotations
    set:
      podAnnotations:
        custom.annotation/key: custom-value
        another.annotation: another-value
    asserts:
      - equal:
          path: spec.template.metadata.annotations["custom.annotation/key"]
          value: custom-value
      - equal:
          path: spec.template.metadata.annotations["another.annotation"]
          value: another-value
      - isNotEmpty:
          path: spec.template.metadata.annotations["checksum/migration-config"]

  # Node selector tests
  - it: should not set node selector by default
    asserts:
      - isNull:
          path: spec.template.spec.nodeSelector

  - it: should set node selector when provided
    set:
      nodeSelector.disktype: ssd
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector.disktype
          value: ssd

  # Monitoring annotations tests
  - it: should not add prometheus annotations when monitoring is disabled
    set:
      monitoring.enabled: false
    asserts:
      - isNull:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
      - isNull:
          path: spec.template.metadata.annotations["prometheus.io/port"]
      - isNull:
          path: spec.template.metadata.annotations["prometheus.io/path"]

  - it: should add prometheus annotations when monitoring is enabled
    set:
      monitoring.enabled: true
    asserts:
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: 'true'
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/port"]
          value: '9090'
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/path"]
          value: '/metrics'

  - it: should merge monitoring annotations with custom podAnnotations
    set:
      monitoring.enabled: true
      podAnnotations:
        custom.annotation/key: custom-value
        another.annotation: another-value
    asserts:
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: 'true'
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/port"]
          value: '9090'
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/path"]
          value: '/metrics'
      - equal:
          path: spec.template.metadata.annotations["custom.annotation/key"]
          value: custom-value
      - equal:
          path: spec.template.metadata.annotations["another.annotation"]
          value: another-value
      - isNotEmpty:
          path: spec.template.metadata.annotations["checksum/migration-config"]
  # Dispatch cluster configuration tests
  - it: should have dispatch enabled by default (matches operator parity)
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DISPATCH_CLUSTER_ENABLED
            value: "true"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DISPATCH_UPSTREAM_ADDR
            value: "RELEASE-NAME-spicedb.NAMESPACE.svc.cluster.local:50053"

  - it: should not set dispatch environment variables when dispatch is disabled
    set:
      dispatch.enabled: false
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DISPATCH_CLUSTER_ENABLED
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DISPATCH_UPSTREAM_ADDR

  - it: should set dispatch environment variables when dispatch is enabled
    set:
      dispatch.enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DISPATCH_CLUSTER_ENABLED
            value: "true"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DISPATCH_UPSTREAM_ADDR
            value: "RELEASE-NAME-spicedb.NAMESPACE.svc.cluster.local:50053"

  - it: should set dispatch upstream CA path when upstreamCASecretName is provided
    set:
      dispatch.enabled: true
      dispatch.upstreamCASecretName: dispatch-upstream-ca
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DISPATCH_UPSTREAM_CA_CERT_PATH
            value: /etc/dispatch-ca/ca.crt

  - it: should mount dispatch upstream CA volume when upstreamCASecretName is provided
    set:
      dispatch.enabled: true
      dispatch.upstreamCASecretName: dispatch-upstream-ca
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dispatch-upstream-ca
            mountPath: /etc/dispatch-ca
            readOnly: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: dispatch-upstream-ca
            secret:
              secretName: dispatch-upstream-ca
              defaultMode: 0400

  - it: should not mount dispatch upstream CA volume when upstreamCASecretName is not provided
    set:
      dispatch.enabled: true
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DISPATCH_UPSTREAM_CA_CERT_PATH
      - notContains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dispatch-upstream-ca

  # Health probe tests
  - it: should configure liveness probe with production defaults
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.grpc.port
          value: 50051
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 30
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.timeoutSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.successThreshold
          value: 1
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.failureThreshold
          value: 3

  - it: should configure readiness probe with production defaults
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.grpc.port
          value: 50051
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.timeoutSeconds
          value: 3
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.successThreshold
          value: 1
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.failureThreshold
          value: 2

  - it: should allow custom liveness probe configuration
    set:
      probes.liveness.initialDelaySeconds: 60
      probes.liveness.periodSeconds: 20
      probes.liveness.timeoutSeconds: 10
      probes.liveness.failureThreshold: 5
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 60
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 20
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.timeoutSeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.failureThreshold
          value: 5

  - it: should allow custom readiness probe configuration
    set:
      probes.readiness.initialDelaySeconds: 20
      probes.readiness.periodSeconds: 10
      probes.readiness.timeoutSeconds: 5
      probes.readiness.failureThreshold: 5
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 20
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.timeoutSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.failureThreshold
          value: 5

