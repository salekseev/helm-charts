suite: Test Production High Availability Preset Configuration
templates:
  - deployment.yaml
  - hpa.yaml
  - poddisruptionbudget.yaml
tests:
  # Test that HA preset creates correct deployment
  - it: should create deployment with HA replica count
    template: deployment.yaml
    values:
      - ../../values-presets/production-ha.yaml
    asserts:
      - isKind:
          of: Deployment
      # Should have 2 base replicas for HA (with HPA scaling to 5)
      - equal:
          path: spec.replicas
          value: 2

  # Test that HPA is created
  - it: should create HPA for autoscaling
    template: hpa.yaml
    values:
      - ../../values-presets/production-ha.yaml
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
      # Should have correct min replicas
      - equal:
          path: spec.minReplicas
          value: 2
      # Should have correct max replicas
      - equal:
          path: spec.maxReplicas
          value: 5
      # Should have CPU target
      - contains:
          path: spec.metrics
          content:
            type: Resource
            resource:
              name: cpu
              target:
                type: Utilization
                averageUtilization: 70
      # Should have memory target
      - contains:
          path: spec.metrics
          content:
            type: Resource
            resource:
              name: memory
              target:
                type: Utilization
                averageUtilization: 80

  # Test that PDB configuration
  - it: should create PDB with maxUnavailable 1
    template: poddisruptionbudget.yaml
    values:
      - ../../values-presets/production-ha.yaml
    asserts:
      - isKind:
          of: PodDisruptionBudget
      # Should allow 1 unavailable
      - equal:
          path: spec.maxUnavailable
          value: 1

  # Test pod anti-affinity configuration
  - it: should configure pod anti-affinity for zone spreading
    template: deployment.yaml
    values:
      - ../../values-presets/production-ha.yaml
    asserts:
      # Should have pod anti-affinity
      - isNotEmpty:
          path: spec.template.spec.affinity.podAntiAffinity
      # Should prefer zone spreading
      - contains:
          path: spec.template.spec.affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution
          content:
            weight: 100
            podAffinityTerm:
              topologyKey: topology.kubernetes.io/zone
              labelSelector:
                matchLabels:
                  app.kubernetes.io/name: spicedb

  # Test topology spread constraints
  - it: should configure topology spread constraints
    template: deployment.yaml
    values:
      - ../../values-presets/production-ha.yaml
    asserts:
      # Should have topology spread constraints
      - isNotEmpty:
          path: spec.template.spec.topologySpreadConstraints
      # Should spread across zones (checking key fields)
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].maxSkew
          value: 1
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].topologyKey
          value: topology.kubernetes.io/zone
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].whenUnsatisfiable
          value: ScheduleAnyway

  # Test layering with production-postgres preset
  - it: should work when layered with production-postgres preset
    template: deployment.yaml
    values:
      - ../../values-presets/production-postgres.yaml
      - ../../values-presets/production-ha.yaml
    set:
      config.existingSecret: spicedb-secrets
      tls.grpc.secretName: spicedb-tls
      tls.http.secretName: spicedb-tls
    asserts:
      - isKind:
          of: Deployment
      # HA preset should override replica count
      - equal:
          path: spec.replicas
          value: 2
      # Should still use postgres datastore from production preset
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DATASTORE_ENGINE
            value: postgres
      # Should have production resource limits
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 500m
      # Should have HA affinity rules
      - isNotEmpty:
          path: spec.template.spec.affinity.podAntiAffinity

  # Test HPA with layered preset
  - it: should create HPA when layered with production preset
    template: hpa.yaml
    values:
      - ../../values-presets/production-postgres.yaml
      - ../../values-presets/production-ha.yaml
    set:
      config.existingSecret: spicedb-secrets
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
      # Should have HA min replicas
      - equal:
          path: spec.minReplicas
          value: 2
