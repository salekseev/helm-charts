suite: test helper templates
templates:
  - deployment.yaml  # We test helpers indirectly through a template that uses them
tests:
  # Test spicedb.fullname helper
  - it: should generate correct fullname
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-spicedb

  - it: should use fullnameOverride when provided
    set:
      fullnameOverride: custom-fullname
    asserts:
      - equal:
          path: metadata.name
          value: custom-fullname

  - it: should use nameOverride in fullname
    set:
      nameOverride: custom-name
    asserts:
      - matchRegex:
          path: metadata.name
          pattern: -custom-name$

  # Test spicedb.labels helper
  - it: should include standard Kubernetes labels
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: spicedb
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm
      - isNotNull:
          path: metadata.labels["helm.sh/chart"]

  # Test spicedb.selectorLabels helper (through spec.selector)
  - it: should have correct selector labels
    asserts:
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/name"]
          value: spicedb
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      # Selector labels should NOT include version or chart
      - isNull:
          path: spec.selector.matchLabels["app.kubernetes.io/version"]

  # Test template metadata labels propagation
  - it: should propagate labels to pod template
    asserts:
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/name"]
          value: spicedb
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
