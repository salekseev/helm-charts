suite: test health probes
templates:
  - deployment.yaml
tests:
  # Startup probe tests
  - it: should have startup probe enabled by default
    asserts:
      - isNotEmpty:
          path: spec.template.spec.containers[0].startupProbe
      - equal:
          path: spec.template.spec.containers[0].startupProbe.grpc.port
          value: 50051

  - it: should configure startup probe with correct defaults
    asserts:
      - equal:
          path: spec.template.spec.containers[0].startupProbe.initialDelaySeconds
          value: 0
      - equal:
          path: spec.template.spec.containers[0].startupProbe.periodSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].startupProbe.timeoutSeconds
          value: 3
      - equal:
          path: spec.template.spec.containers[0].startupProbe.successThreshold
          value: 1
      - equal:
          path: spec.template.spec.containers[0].startupProbe.failureThreshold
          value: 30

  - it: should allow customizing startup probe settings
    set:
      probes.startup.initialDelaySeconds: 5
      probes.startup.periodSeconds: 10
      probes.startup.timeoutSeconds: 5
      probes.startup.failureThreshold: 20
    asserts:
      - equal:
          path: spec.template.spec.containers[0].startupProbe.initialDelaySeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].startupProbe.periodSeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].startupProbe.timeoutSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].startupProbe.failureThreshold
          value: 20

  - it: should disable startup probe when disabled
    set:
      probes.startup.enabled: false
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].startupProbe

  # Liveness probe tests
  - it: should have liveness probe with correct defaults
    asserts:
      - isNotEmpty:
          path: spec.template.spec.containers[0].livenessProbe
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.grpc.port
          value: 50051
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 30
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.timeoutSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.failureThreshold
          value: 3

  - it: should support HTTP liveness probe fallback
    set:
      probes.liveness.protocol: http
    asserts:
      - isNotEmpty:
          path: spec.template.spec.containers[0].livenessProbe
      - isNull:
          path: spec.template.spec.containers[0].livenessProbe.grpc
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /healthz
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 8443
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.scheme
          value: HTTPS

  - it: should disable liveness probe when disabled
    set:
      probes.liveness.enabled: false
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].livenessProbe

  - it: should customize liveness probe HTTP settings
    set:
      probes.liveness.protocol: http
      probes.liveness.http.path: /custom-health
      probes.liveness.http.port: 9000
      probes.liveness.http.scheme: HTTP
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /custom-health
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 9000
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.scheme
          value: HTTP

  # Readiness probe tests
  - it: should have readiness probe with correct defaults
    asserts:
      - isNotEmpty:
          path: spec.template.spec.containers[0].readinessProbe
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.grpc.port
          value: 50051
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.timeoutSeconds
          value: 3
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.failureThreshold
          value: 2

  - it: should support HTTP readiness probe fallback
    set:
      probes.readiness.protocol: http
    asserts:
      - isNotEmpty:
          path: spec.template.spec.containers[0].readinessProbe
      - isNull:
          path: spec.template.spec.containers[0].readinessProbe.grpc
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /healthz
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 8443
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.scheme
          value: HTTPS

  - it: should disable readiness probe when disabled
    set:
      probes.readiness.enabled: false
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].readinessProbe

  - it: should customize readiness probe HTTP settings
    set:
      probes.readiness.protocol: http
      probes.readiness.http.path: /ready
      probes.readiness.http.port: 9000
      probes.readiness.http.scheme: HTTP
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /ready
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 9000
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.scheme
          value: HTTP

  # Combined probe configuration test
  - it: should have all three probes configured for production HA
    set:
      replicaCount: 3
    asserts:
      - isNotEmpty:
          path: spec.template.spec.containers[0].startupProbe
      - isNotEmpty:
          path: spec.template.spec.containers[0].livenessProbe
      - isNotEmpty:
          path: spec.template.spec.containers[0].readinessProbe

  # Mixed protocol test
  - it: should support different protocols for liveness and readiness
    set:
      probes.liveness.protocol: grpc
      probes.readiness.protocol: http
    asserts:
      - isNotEmpty:
          path: spec.template.spec.containers[0].livenessProbe.grpc
      - isNull:
          path: spec.template.spec.containers[0].livenessProbe.httpGet
      - isNotEmpty:
          path: spec.template.spec.containers[0].readinessProbe.httpGet
      - isNull:
          path: spec.template.spec.containers[0].readinessProbe.grpc

