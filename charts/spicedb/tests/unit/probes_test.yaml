suite: test health probes
templates:
  - deployment.yaml
tests:
  # Startup probe tests
  - it: should have startup probe enabled by default
    asserts:
      - isNotEmpty:
          path: spec.template.spec.containers[0].startupProbe
      - equal:
          path: spec.template.spec.containers[0].startupProbe.grpc.port
          value: 50051

  - it: should configure startup probe with correct defaults
    asserts:
      - equal:
          path: spec.template.spec.containers[0].startupProbe.initialDelaySeconds
          value: 0
      - equal:
          path: spec.template.spec.containers[0].startupProbe.periodSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].startupProbe.timeoutSeconds
          value: 3
      - equal:
          path: spec.template.spec.containers[0].startupProbe.successThreshold
          value: 1
      - equal:
          path: spec.template.spec.containers[0].startupProbe.failureThreshold
          value: 30

  - it: should allow customizing startup probe settings
    set:
      probes.startup.initialDelaySeconds: 5
      probes.startup.periodSeconds: 10
      probes.startup.timeoutSeconds: 5
      probes.startup.failureThreshold: 20
    asserts:
      - equal:
          path: spec.template.spec.containers[0].startupProbe.initialDelaySeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].startupProbe.periodSeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].startupProbe.timeoutSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].startupProbe.failureThreshold
          value: 20

  - it: should disable startup probe when disabled
    set:
      probes.startup.enabled: false
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].startupProbe

  # Liveness probe tests
  - it: should have liveness probe with correct defaults
    asserts:
      - isNotEmpty:
          path: spec.template.spec.containers[0].livenessProbe
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.grpc.port
          value: 50051
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 30
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.failureThreshold
          value: 3

  # Readiness probe tests
  - it: should have readiness probe with correct defaults
    asserts:
      - isNotEmpty:
          path: spec.template.spec.containers[0].readinessProbe
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.grpc.port
          value: 50051
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.failureThreshold
          value: 2

  # Combined probe configuration test
  - it: should have all three probes configured for production HA
    set:
      replicaCount: 3
    asserts:
      - isNotEmpty:
          path: spec.template.spec.containers[0].startupProbe
      - isNotEmpty:
          path: spec.template.spec.containers[0].livenessProbe
      - isNotEmpty:
          path: spec.template.spec.containers[0].readinessProbe
