suite: test auto-secret generation
templates:
  - secret.yaml
tests:
  # Test 1: Secret generated when autogenerateSecret=true and existingSecret empty
  - it: should create secret when autogenerateSecret is true and no existingSecret
    set:
      config:
        autogenerateSecret: true
        existingSecret: ""
        datastoreEngine: postgres
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-spicedb
      - isNotNull:
          path: data.preshared-key
      - isNotNull:
          path: data.datastore-uri

  # Test 2: Secret contains warning annotation
  - it: should have warning annotation when secret is auto-generated
    set:
      config:
        autogenerateSecret: true
        existingSecret: ""
        datastoreEngine: postgres
    asserts:
      - equal:
          path: metadata.annotations["spicedb.authzed.com/warning"]
          value: "This secret was auto-generated. NOT suitable for production. Generate a secure preshared key and use existingSecret."

  # Test 3: Secret not created when existingSecret is set
  - it: should not create secret when existingSecret is set
    set:
      config:
        autogenerateSecret: true
        existingSecret: "my-existing-secret"
        datastoreEngine: postgres
    asserts:
      - hasDocuments:
          count: 0

  # Test 4: Secret not created when autogenerateSecret=false
  - it: should not create secret when autogenerateSecret is false
    set:
      config:
        autogenerateSecret: false
        existingSecret: ""
        datastoreEngine: postgres
    asserts:
      - hasDocuments:
          count: 0

  # Test 5: Secret not created for memory datastore
  - it: should not create secret when datastoreEngine is memory
    set:
      config:
        autogenerateSecret: true
        existingSecret: ""
        datastoreEngine: memory
    asserts:
      - hasDocuments:
          count: 0

  # Test 6: Secret has correct structure
  - it: should have correct secret structure with required keys
    set:
      config:
        autogenerateSecret: true
        existingSecret: ""
        datastoreEngine: postgres
        datastore:
          hostname: "postgres.example.com"
          port: 5432
          username: "spicedb"
          password: "testpassword"
          database: "spicedb"
          sslMode: "disable"
    asserts:
      - equal:
          path: type
          value: Opaque
      - isNotNull:
          path: data["preshared-key"]
      - isNotNull:
          path: data["datastore-uri"]

  # Test 7: Secret has Helm hook annotations
  - it: should have correct Helm hook annotations
    set:
      config:
        autogenerateSecret: true
        existingSecret: ""
        datastoreEngine: postgres
    asserts:
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: "pre-install,pre-upgrade"
      - equal:
          path: metadata.annotations["helm.sh/hook-weight"]
          value: "-1"
      - equal:
          path: metadata.annotations["helm.sh/hook-delete-policy"]
          value: "before-hook-creation"

  # Test 8: operatorStyle.secretName prevents secret creation
  - it: should not create secret when operatorStyle.secretName is set
    set:
      operatorStyle:
        enabled: true
        secretName: "operator-secret"
        replicas: 3
        datastoreEngine: postgres
      config:
        autogenerateSecret: true
        existingSecret: ""
    asserts:
      - hasDocuments:
          count: 0

  # Test 9: Secret includes standard labels
  - it: should include standard Kubernetes labels
    set:
      config:
        autogenerateSecret: true
        existingSecret: ""
        datastoreEngine: postgres
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: spicedb
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm

  # Test 10: CockroachDB datastore also creates secret
  - it: should create secret for CockroachDB datastore
    set:
      config:
        autogenerateSecret: true
        existingSecret: ""
        datastoreEngine: cockroachdb
        datastore:
          hostname: "cockroachdb.example.com"
          port: 26257
          username: "spicedb"
          password: "testpassword"
          database: "spicedb"
          sslMode: "verify-full"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - isNotNull:
          path: data.preshared-key
      - isNotNull:
          path: data.datastore-uri
