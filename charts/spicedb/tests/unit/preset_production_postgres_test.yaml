suite: Test Production PostgreSQL Preset Configuration
templates:
  - deployment.yaml
  - service.yaml
  - poddisruptionbudget.yaml
tests:
  # Test that production-postgres preset creates correct deployment
  - it: should create deployment with production postgres settings
    template: deployment.yaml
    values:
      - ../../values-presets/production-postgres.yaml
    set:
      config.existingSecret: spicedb-secrets
      tls.grpc.secretName: spicedb-tls
      tls.http.secretName: spicedb-tls
    asserts:
      - isKind:
          of: Deployment
      # Should have 2 replicas for basic HA (operator minimal defaults)
      - equal:
          path: spec.replicas
          value: 2
      # Should use PostgreSQL datastore
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DATASTORE_ENGINE
            value: postgres
      # Should have info logging for production
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_LOG_LEVEL
            value: info
      # Should have JSON log format
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_LOG_FORMAT
            value: json
      # Should have production resource limits
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 1Gi
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 2000m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 4Gi

  # Test that TLS is enabled
  - it: should configure TLS for production
    template: deployment.yaml
    values:
      - ../../values-presets/production-postgres.yaml
    set:
      config.existingSecret: spicedb-secrets
      tls.grpc.secretName: spicedb-tls
      tls.http.secretName: spicedb-tls
    asserts:
      # Should have TLS environment variables for gRPC
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_GRPC_TLS_CERT_PATH
            value: /etc/spicedb/tls/grpc/tls.crt
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_GRPC_TLS_KEY_PATH
            value: /etc/spicedb/tls/grpc/tls.key

  # Test that PDB is created
  - it: should create PDB for high availability
    template: poddisruptionbudget.yaml
    values:
      - ../../values-presets/production-postgres.yaml
    set:
      config.existingSecret: spicedb-secrets
    asserts:
      - isKind:
          of: PodDisruptionBudget
      - equal:
          path: spec.maxUnavailable
          value: 1

  # Test that service is created correctly
  - it: should create service with standard ports
    template: service.yaml
    values:
      - ../../values-presets/production-postgres.yaml
    set:
      config.existingSecret: spicedb-secrets
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.type
          value: ClusterIP
      # Should expose all required ports
      - contains:
          path: spec.ports
          content:
            name: grpc
            port: 50051
            protocol: TCP
            targetPort: grpc

  # Test that datastore URI comes from existing secret
  - it: should use existing secret for datastore credentials
    template: deployment.yaml
    values:
      - ../../values-presets/production-postgres.yaml
    set:
      config.existingSecret: spicedb-secrets
    asserts:
      # Should reference the existing secret
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SPICEDB_DATASTORE_CONN_URI
            valueFrom:
              secretKeyRef:
                name: spicedb-secrets
                key: datastore-uri
