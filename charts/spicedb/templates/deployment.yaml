apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "spicedb.fullname" . }}
  labels:
    {{- include "spicedb.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  {{- if .Values.updateStrategy }}
  # Rolling update strategy for zero-downtime deployments
  # maxUnavailable: 0 ensures at least one pod is always available
  # maxSurge: 1 allows one extra pod during updates to maintain availability
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: {{ .Values.updateStrategy.rollingUpdate.maxUnavailable }}
      maxSurge: {{ .Values.updateStrategy.rollingUpdate.maxSurge }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "spicedb.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        # Trigger rolling update when migration configuration changes
        # This ensures deployments restart after migrations complete with new settings
        checksum/migration-config: {{ .Values.migrations | toJson | sha256sum }}
        {{- if .Values.monitoring.enabled }}
        # Prometheus metrics scraping annotations
        prometheus.io/scrape: 'true'
        prometheus.io/port: '9090'
        prometheus.io/path: '/metrics'
        {{- end }}
        {{- with .Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "spicedb.labels" . | nindent 8 }}
        {{- with .Values.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "spicedb.serviceAccountName" . }}
      {{- with .Values.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
      - name: spicedb
        {{- with .Values.securityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        command:
        - spicedb
        - serve
        ports:
        - name: grpc
          containerPort: 50051
          protocol: TCP
        - name: http
          containerPort: 8443
          protocol: TCP
        - name: metrics
          containerPort: 9090
          protocol: TCP
        - name: dispatch
          containerPort: 50053
          protocol: TCP
        env:
        - name: SPICEDB_GRPC_PRESHARED_KEY
          value: {{ .Values.config.presharedKey | quote }}
        - name: SPICEDB_DATASTORE_ENGINE
          value: {{ .Values.config.datastoreEngine }}
        # Logging configuration
        # SPICEDB_LOG_LEVEL controls verbosity: debug, info, warn, error
        - name: SPICEDB_LOG_LEVEL
          value: {{ .Values.logging.level }}
        # SPICEDB_LOG_FORMAT controls output format: json (structured), console (human-readable)
        - name: SPICEDB_LOG_FORMAT
          value: {{ .Values.logging.format }}
        {{- if ne .Values.config.datastoreEngine "memory" }}
        - name: SPICEDB_DATASTORE_CONN_URI
          valueFrom:
            secretKeyRef:
              name: {{ .Values.config.existingSecret | default (include "spicedb.fullname" .) }}
              key: datastore-uri
        {{- end }}
        # gRPC TLS configuration
        # These environment variables tell SpiceDB where to find TLS certificates for the gRPC endpoint
        {{- if .Values.tls.grpc.secretName }}
        - name: SPICEDB_GRPC_TLS_CERT_PATH
          value: {{ .Values.tls.grpc.certPath | quote }}
        - name: SPICEDB_GRPC_TLS_KEY_PATH
          value: {{ .Values.tls.grpc.keyPath | quote }}
        - name: SPICEDB_GRPC_TLS_CA_PATH
          value: {{ .Values.tls.grpc.caPath | quote }}
        {{- end }}
        # HTTP TLS configuration
        # These environment variables tell SpiceDB where to find TLS certificates for the HTTP endpoint
        {{- if .Values.tls.http.secretName }}
        - name: SPICEDB_HTTP_TLS_CERT_PATH
          value: {{ .Values.tls.http.certPath | quote }}
        - name: SPICEDB_HTTP_TLS_KEY_PATH
          value: {{ .Values.tls.http.keyPath | quote }}
        {{- end }}
        {{- if and .Values.tls.enabled .Values.tls.dispatch.secretName }}
        # Dispatch cluster mTLS configuration
        # All three paths (cert, key, CA) are required for mutual TLS authentication
        # between SpiceDB instances in the cluster
        - name: SPICEDB_DISPATCH_CLUSTER_TLS_CERT_PATH
          value: {{ .Values.tls.dispatch.certPath | quote }}
        - name: SPICEDB_DISPATCH_CLUSTER_TLS_KEY_PATH
          value: {{ .Values.tls.dispatch.keyPath | quote }}
        - name: SPICEDB_DISPATCH_CLUSTER_TLS_CA_PATH
          value: {{ .Values.tls.dispatch.caPath | quote }}
        {{- end }}
        {{- if .Values.dispatch.enabled }}
        # Dispatch cluster configuration
        # Enables distributed dispatch across SpiceDB instances for horizontal scaling
        - name: SPICEDB_DISPATCH_CLUSTER_ENABLED
          value: "true"
        # Kubernetes DNS-based service discovery for dispatch cluster
        # Format: <service-name>.<namespace>.svc.cluster.local:<port>
        # This allows SpiceDB instances to discover and communicate with each other
        - name: SPICEDB_DISPATCH_UPSTREAM_ADDR
          value: "{{ include "spicedb.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local:50053"
        {{- if .Values.dispatch.upstreamCASecretName }}
        # CA certificate for verifying upstream dispatch connections
        # Required when using custom CA for dispatch cluster communication
        - name: SPICEDB_DISPATCH_UPSTREAM_CA_CERT_PATH
          value: /etc/dispatch-ca/ca.crt
        {{- end }}
        {{- end }}
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        {{- if and .Values.tls.enabled .Values.tls.grpc.secretName }}
        # Mount gRPC TLS certificates for securing client-to-SpiceDB communication
        - name: tls-grpc-certs
          mountPath: /etc/spicedb/tls/grpc
          readOnly: true
        {{- end }}
        {{- if and .Values.tls.enabled .Values.tls.http.secretName }}
        # Mount HTTP TLS certificates for securing dashboard and metrics endpoints
        - name: tls-http-certs
          mountPath: /etc/spicedb/tls/http
          readOnly: true
        {{- end }}
        {{- if and .Values.tls.enabled .Values.tls.dispatch.secretName }}
        # Mount dispatch TLS certificates for securing internal cluster communication (mTLS)
        - name: tls-dispatch-certs
          mountPath: /etc/spicedb/tls/dispatch
          readOnly: true
        {{- end }}
        {{- if and .Values.tls.enabled .Values.tls.datastore.secretName }}
        # Mount datastore TLS certificates for securing database connections
        - name: tls-datastore-certs
          mountPath: /etc/spicedb/tls/datastore
          readOnly: true
        {{- end }}
        {{- if and .Values.dispatch.enabled .Values.dispatch.upstreamCASecretName }}
        # Mount dispatch upstream CA certificate for verifying cluster communication
        - name: dispatch-upstream-ca
          mountPath: /etc/dispatch-ca
          readOnly: true
        {{- end }}
        # Health check probes
        # SpiceDB uses a distroless container image without shell or curl
        # Therefore, we use native gRPC health probes which are supported by Kubernetes
        # and work with both TLS and non-TLS configurations
        #
        # Note: gRPC health probes check the gRPC endpoint, not the HTTP endpoint
        # This is appropriate since gRPC is the primary API for SpiceDB
        # The HTTP endpoint is mainly for dashboard and metrics
        readinessProbe:
          grpc:
            port: 50051
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 3
          successThreshold: 1
          failureThreshold: 3
        # Liveness probe checks if SpiceDB is still running
        # If this fails, Kubernetes will restart the container
        livenessProbe:
          grpc:
            port: 50051
          initialDelaySeconds: 15
          periodSeconds: 20
          timeoutSeconds: 3
          successThreshold: 1
          failureThreshold: 3
        {{- with .Values.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- if .Values.affinity }}
      # Custom affinity rules (full override)
      affinity:
        {{- toYaml .Values.affinity | nindent 8 }}
      {{- else if gt (int .Values.replicaCount) 1 }}
      # Default pod anti-affinity for high availability
      # Spreads pods across availability zones to prevent single zone failures
      # Uses preferredDuringScheduling so pods can still be scheduled if zones are full
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  {{- include "spicedb.selectorLabels" . | nindent 18 }}
              topologyKey: topology.kubernetes.io/zone
      {{- end }}
      {{- if gt (int .Values.replicaCount) 1 }}
      # Topology spread constraints for even distribution
      # Ensures pods are spread evenly across availability zones
      # maxSkew: 1 means zones can differ by at most 1 pod
      # ScheduleAnyway allows scheduling even if constraint can't be met
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: topology.kubernetes.io/zone
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            {{- include "spicedb.selectorLabels" . | nindent 12 }}
      {{- end }}
      volumes:
      - name: tmp
        emptyDir: {}
      {{- if and .Values.tls.enabled .Values.tls.grpc.secretName }}
      # Volume for gRPC TLS certificates
      # Mounts the Kubernetes secret containing server cert, key, and optional CA cert
      - name: tls-grpc-certs
        secret:
          secretName: {{ .Values.tls.grpc.secretName }}
          defaultMode: 0400
      {{- end }}
      {{- if and .Values.tls.enabled .Values.tls.http.secretName }}
      # Volume for HTTP TLS certificates
      # Mounts the Kubernetes secret containing server cert and key for dashboard/metrics
      - name: tls-http-certs
        secret:
          secretName: {{ .Values.tls.http.secretName }}
          defaultMode: 0400
      {{- end }}
      {{- if and .Values.tls.enabled .Values.tls.dispatch.secretName }}
      # Volume for dispatch cluster TLS certificates
      # Mounts the Kubernetes secret containing cert, key, and CA for mTLS between nodes
      - name: tls-dispatch-certs
        secret:
          secretName: {{ .Values.tls.dispatch.secretName }}
          defaultMode: 0400
      {{- end }}
      {{- if and .Values.tls.enabled .Values.tls.datastore.secretName }}
      # Volume for datastore TLS certificates
      # Mounts the Kubernetes secret containing CA cert and optional client cert/key
      - name: tls-datastore-certs
        secret:
          secretName: {{ .Values.tls.datastore.secretName }}
          defaultMode: 0400
      {{- end }}
      {{- if and .Values.dispatch.enabled .Values.dispatch.upstreamCASecretName }}
      # Volume for dispatch upstream CA certificate
      # Mounts the Kubernetes secret containing CA cert for verifying upstream connections
      - name: dispatch-upstream-ca
        secret:
          secretName: {{ .Values.dispatch.upstreamCASecretName }}
          defaultMode: 0400
      {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
