name: Integration Tests

# Comprehensive integration tests across multiple Kubernetes versions
# Uses multi-node Kind cluster (1 control-plane + 2 workers) to test:
# - HA deployments with multiple replicas
# - Dispatch cluster communication across pods
# - Pod distribution and anti-affinity
# - Production-like deployment scenarios
#
# These tests are resource-intensive and take 30-54 minutes to complete
#
# Trigger conditions:
# 1. Always runs on pushes to master branch
# 2. On PRs: Only when maintainer adds 'run-integration-tests' label
# 3. Manual: Can be triggered via workflow_dispatch
#
# This approach balances thorough testing with CI resource efficiency

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:

jobs:
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    # Run if:
    # - Push to master, OR
    # - PR has 'run-integration-tests' label, OR
    # - Manual workflow_dispatch trigger
    # - Never run in 'act' (local testing)
    if: |
      github.event_name != 'act' && (
        github.event_name == 'push' ||
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-integration-tests'))
      )
    strategy:
      matrix:
        k8s-version:
          - v1.28.0
          - v1.29.0
          - v1.30.0
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Set up Kind
        uses: helm/kind-action@v1.13.0
        with:
          node_image: kindest/node:${{ matrix.k8s-version }}
          cluster_name: spicedb-test
          config: charts/spicedb/tests/integration/kind-cluster-config.yaml
          wait: 5m

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.30.0'

      - name: Run integration tests
        run: |
          cd charts/spicedb
          make test-integration

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: integration-test-logs-k8s-${{ matrix.k8s-version }}
          path: charts/spicedb/tests/integration/logs/
          retention-days: 7

  integration-test-skip:
    name: Integration Tests (Skipped)
    runs-on: ubuntu-latest
    # Show as skipped when integration tests don't run on PRs
    if: |
      github.event_name == 'pull_request' &&
      !contains(github.event.pull_request.labels.*.name, 'run-integration-tests')
    steps:
      - name: Integration tests skipped
        run: |
          echo "⏭️  Integration tests skipped for this PR"
          echo ""
          echo "Integration tests are optional for PRs to save CI resources."
          echo "They automatically run on all pushes to master."
          echo ""
          echo "To run integration tests on this PR:"
          echo "  1. Add the 'run-integration-tests' label, OR"
          echo "  2. Ask a maintainer to trigger them manually"
          echo ""
          echo "Integration tests verify chart deployment across:"
          echo "  - Kubernetes v1.28.0"
          echo "  - Kubernetes v1.29.0"
          echo "  - Kubernetes v1.30.0"
