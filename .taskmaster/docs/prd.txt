<context>
# Overview
The SpiceDB Helm Chart project aims to create a production-ready, operator-free deployment solution for SpiceDB on Kubernetes. This chart will replicate the functionality of the official spicedb-operator using native Kubernetes primitives, making SpiceDB accessible to teams that prefer Helm-based deployments or operate in environments where operators are restricted.

**Problem Statement:**
Organizations deploying SpiceDB currently have two options: (1) manually manage Kubernetes manifests, which is error-prone and lacks best practices, or (2) use the spicedb-operator, which requires operator installation and ongoing management. Many teams prefer Helm for its simplicity, GitOps compatibility, and declarative configuration management.

**Target Users:**
- Platform engineers deploying SpiceDB in production Kubernetes environments
- DevOps teams using Helm as their primary deployment tool
- Organizations with security policies restricting Kubernetes operators
- AWS EKS users requiring EKS Pod Identity for IAM authentication
- Teams requiring RDS IAM authentication for database connectivity

**Value Proposition:**
A comprehensive, test-driven Helm chart that provides operator-level functionality while remaining simple to deploy, upgrade, and maintain. The chart will support all SpiceDB features including multi-datastore backends, TLS configuration, horizontal scaling, automated migrations, and AWS-native authentication patterns.

# Core Features

## 1. Multi-Datastore Support
**What it does:** Enables SpiceDB deployment with five different backend datastores: PostgreSQL, CockroachDB, MySQL, Cloud Spanner, and in-memory (development).

**Why it's important:** Different organizations have different database preferences and existing infrastructure. Supporting multiple backends ensures broad adoption.

**How it works:** Template logic conditionally configures environment variables, connection strings, and volume mounts based on the selected datastore engine. Each datastore has validated configuration patterns extracted from the operator.

## 2. AWS EKS Pod Identity Integration for RDS
**What it does:** Provides native AWS IAM authentication to RDS databases using EKS Pod Identity, eliminating the need for database passwords and OIDC provider configuration.

**Why it's important:** Password-based authentication introduces security risks. EKS Pod Identity follows AWS security best practices by using temporary credentials that automatically rotate, while simplifying operations compared to IRSA by removing OIDC dependencies.

**How it works:**
- EKS Pod Identity Agent deployed in cluster (one-time setup)
- ServiceAccount associated with IAM role via EKS Pod Identity association
- Init container generates RDS IAM token using AWS CLI
- Optional sidecar container refreshes tokens for long-running deployments
- Uses `pods.eks.amazonaws.com` service principal (reusable across clusters)
- Credentials fetched once per node for improved scalability

## 3. Automated Schema Migrations
**What it does:** Executes database schema migrations automatically during install and upgrade operations using Helm hooks.

**Why it's important:** SpiceDB version upgrades often require database migrations. Automating this prevents deployment failures and data inconsistencies.

**How it works:**
- Pre-install/pre-upgrade hooks create Kubernetes Jobs
- Migration jobs run SpiceDB migrate command with target version
- Deployment waits for successful migration completion
- Post-hooks clean up completed migration jobs
- Support for phased migrations (multi-step upgrades)

## 4. Comprehensive TLS Support
**What it does:** Configures TLS for all SpiceDB endpoints: gRPC, HTTP gateway, dispatch cluster, and datastore connections.

**Why it's important:** Production deployments require encrypted communications. Supporting multiple TLS configurations enables defense-in-depth security.

**How it works:**
- Secret-based certificate management
- Separate TLS configuration for each endpoint
- Certificate rotation via Kubernetes secret updates
- Integration with cert-manager for automated certificate management

## 5. High Availability Configuration
**What it does:** Provides production-ready HA features including pod disruption budgets, horizontal pod autoscaling, anti-affinity rules, and topology spread constraints.

**Why it's important:** SpiceDB is a critical authorization service. Downtime directly impacts application availability.

**How it works:**
- Deployment with configurable replica count
- PodDisruptionBudget ensures minimum availability during node maintenance
- HPA scales based on CPU/memory metrics
- Anti-affinity spreads pods across zones
- Rolling updates with zero downtime (maxUnavailable: 0)

## 6. Dispatch Cluster Mode
**What it does:** Enables distributed permission checking across multiple SpiceDB pods using Kubernetes service discovery.

**Why it's important:** Large-scale deployments require horizontal scalability. Dispatch mode distributes query load across the cluster.

**How it works:**
- Kubernetes DNS-based service discovery
- Mutual TLS for inter-pod communication
- Automatic cluster membership management
- Configurable upstream CA certificates

## 7. Observability Integration
**What it does:** Exposes Prometheus metrics, structured logging, and integrates with monitoring tools.

**Why it's important:** Production systems require visibility into performance, errors, and usage patterns.

**How it works:**
- Prometheus metrics endpoint on port 9090
- ServiceMonitor CRD for Prometheus Operator
- Configurable log levels (separate for runtime and migrations)
- Pod labels/annotations for metadata projection

## 8. Test-Driven Development Framework
**What it does:** Provides comprehensive test coverage using helm-unittest and OPA policy validation.

**Why it's important:** Ensures chart reliability, prevents regressions, and serves as living documentation.

**How it works:**
- Unit tests for each template using helm-unittest
- Snapshot testing for complex configurations
- OPA/Conftest policies for security validation
- CI/CD pipeline with automated testing

# User Experience

## User Personas

### Persona 1: Platform Engineer (Primary)
**Name:** Sarah
**Role:** Senior Platform Engineer at a mid-size SaaS company
**Goals:**
- Deploy SpiceDB securely in EKS production environment
- Use EKS Pod Identity for RDS authentication (no password management)
- Integrate with existing monitoring (Prometheus)
- Maintain deployment with GitOps (ArgoCD)

**Pain Points:**
- Operators add complexity to the platform
- Needs fine-grained control over Kubernetes resources
- Must comply with security policies (no privileged containers)

### Persona 2: DevOps Engineer (Secondary)
**Name:** Alex
**Role:** DevOps Engineer at a startup
**Goals:**
- Quick SpiceDB deployment for development environments
- Easy upgrades with minimal downtime
- Cost optimization (right-sizing resources)

**Pain Points:**
- Limited Kubernetes expertise
- Small team, needs simple deployment process
- Tight deadlines

### Persona 3: Security Engineer (Influencer)
**Name:** Marcus
**Role:** Security Engineer reviewing deployment patterns
**Goals:**
- Ensure least-privilege access
- Validate TLS configuration
- Audit deployment for compliance (SOC 2, PCI)

**Pain Points:**
- Needs to review and approve all production deployments
- Requires documentation of security features
- Must validate encryption at rest and in transit

## Key User Flows

### Flow 1: Initial Production Deployment (Sarah - Platform Engineer)

1. **Preparation:**
   - Review SpiceDB requirements and architecture
   - Provision RDS PostgreSQL instance with IAM authentication enabled
   - Install EKS Pod Identity Agent in cluster (one-time setup)
   - Create IAM role with RDS IAM policy and trust relationship for `pods.eks.amazonaws.com`
   - Create EKS Pod Identity association for ServiceAccount
   - Generate TLS certificates (or configure cert-manager)

2. **Configuration:**
   - Clone Helm chart repository
   - Copy production-postgres-podidentity.yaml example
   - Customize values:
     - Set datastore engine to postgres
     - Configure Pod Identity IAM role ARN
     - Set RDS hostname and database name
     - Enable TLS for all endpoints
     - Configure resource limits
     - Set replica count (3 for production)

3. **Validation:**
   - Run `helm lint` to check chart validity
   - Run `helm template` to preview rendered manifests
   - Review generated resources
   - Run OPA policy checks with Conftest

4. **Deployment:**
   - Create namespace: `kubectl create namespace spicedb`
   - Install chart: `helm install spicedb . -f production-values.yaml -n spicedb`
   - Monitor migration job: `kubectl logs -n spicedb job/spicedb-migrate-xxx`
   - Wait for pods ready: `kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=spicedb`

5. **Verification:**
   - Check pod status
   - Verify EKS Pod Identity association exists
   - Test connectivity with zed CLI
   - Validate TLS configuration
   - Check Prometheus metrics endpoint

6. **Integration:**
   - Configure Ingress for external access
   - Add ServiceMonitor for Prometheus
   - Document connection details for application teams

**Expected Time:** 2-3 hours for first deployment

### Flow 2: Version Upgrade (Sarah - Platform Engineer)

1. **Preparation:**
   - Review SpiceDB changelog for breaking changes
   - Check if migration is required
   - Backup database (if critical)
   - Review upgrade path in chart documentation

2. **Testing:**
   - Deploy new version to staging environment
   - Validate migrations run successfully
   - Test application compatibility
   - Monitor performance

3. **Production Upgrade:**
   - Update chart version in GitOps repository
   - Update `values.yaml` with new SpiceDB version (if needed)
   - Trigger deployment via ArgoCD or `helm upgrade`
   - Monitor migration hook execution
   - Watch rolling update progress
   - Validate zero downtime (monitor application metrics)

4. **Rollback (if needed):**
   - Execute: `helm rollback spicedb`
   - Monitor rollback completion
   - Investigate failure in migration logs

**Expected Time:** 30 minutes for standard upgrade, 1-2 hours for major version with migration

### Flow 3: Development Environment Setup (Alex - DevOps Engineer)

1. **Quick Start:**
   - Install chart with memory datastore:
     ```
     helm install dev-spicedb . \
       --set config.datastoreEngine=memory \
       --set config.replicas=1 \
       --set config.tls.enabled=false
     ```

2. **Access:**
   - Port forward: `kubectl port-forward svc/dev-spicedb 50051:50051`
   - Connect with zed: `zed context set dev localhost:50051 <preshared-key>`

3. **Cleanup:**
   - Uninstall: `helm uninstall dev-spicedb`

**Expected Time:** 5 minutes

## UI/UX Considerations

### Configuration Experience
- **Progressive Disclosure:** Basic values.yaml uses sensible defaults; advanced features documented separately
- **Examples Over Documentation:** Provide example values files for common scenarios
- **Validation Feedback:** values.schema.json provides immediate validation errors
- **Clear Error Messages:** Helm hooks include descriptive failure messages

### Deployment Feedback
- **NOTES.txt:** Post-install instructions show connection commands, next steps
- **Migration Progress:** Clear logging from migration jobs
- **Status Visibility:** Kubernetes events show deployment progress

### Documentation Structure
- **Quickstart:** Get running in 5 minutes (memory mode)
- **Production Guide:** Step-by-step for production deployment
- **EKS Pod Identity Guide:** Detailed AWS setup instructions with IAM role and association creation
- **Troubleshooting:** Common issues and solutions
- **Migration Guide:** Version upgrade paths

</context>

<PRD>
# Technical Architecture

## System Components

### 1. Helm Chart Structure
```
spicedb/
├── Chart.yaml                    # Chart metadata, version, dependencies
├── values.yaml                   # Default configuration values
├── values.schema.json            # JSON schema for validation
├── templates/                    # Kubernetes manifest templates
│   ├── _helpers.tpl             # Reusable template functions
│   ├── NOTES.txt                # Post-install instructions
│   ├── serviceaccount.yaml      # K8s ServiceAccount for Pod Identity
│   ├── rbac.yaml                # Role + RoleBinding for endpoint discovery
│   ├── secret.yaml              # Secret management (conditional)
│   ├── configmap.yaml           # RDS token generation scripts for Pod Identity
│   ├── service.yaml             # ClusterIP service for SpiceDB
│   ├── deployment.yaml          # Main SpiceDB deployment
│   ├── poddisruptionbudget.yaml # HA configuration
│   ├── hpa.yaml                 # Horizontal Pod Autoscaler
│   ├── ingress.yaml             # Ingress for external access
│   ├── servicemonitor.yaml      # Prometheus integration
│   ├── networkpolicy.yaml       # Network segmentation
│   └── hooks/
│       ├── migration-job.yaml   # Pre-install/upgrade migration
│       └── migration-cleanup.yaml # Post-install cleanup
├── tests/                        # helm-unittest test suites
├── policies/                     # OPA/Conftest policies
├── ci/                          # CI test value files
└── examples/                     # Production example configurations
```

### 2. Kubernetes Resources

**Core Resources:**
- **ServiceAccount:** Kubernetes identity for Pod Identity association
- **Role + RoleBinding:** RBAC for Kubernetes API access (endpoint discovery)
- **Secret:** Stores preshared key and datastore credentials (if not using Pod Identity)
- **ConfigMap:** RDS token generation scripts for Pod Identity, configuration data
- **Service:** ClusterIP service exposing ports 50051 (gRPC), 8443 (HTTP), 9090 (metrics), 50053 (dispatch)
- **Deployment:** SpiceDB pods with configurable replicas, health probes, resource limits

**High Availability Resources:**
- **PodDisruptionBudget:** Ensures minimum availability during disruptions
- **HorizontalPodAutoscaler:** Auto-scales based on CPU/memory

**Optional Resources:**
- **Ingress:** External access configuration
- **ServiceMonitor:** Prometheus Operator integration
- **NetworkPolicy:** Network segmentation rules

**Hook Resources:**
- **Job (pre-install/pre-upgrade):** Database migration execution
- **Job (post-install/post-upgrade):** Cleanup completed migrations

### 3. Data Models

**values.yaml Schema:**
```yaml
image:
  repository: string          # Container image repository
  tag: string                # Image tag (defaults to appVersion)
  pullPolicy: string         # Image pull policy
  pullSecrets: []            # Image pull secrets

config:
  datastoreEngine: enum      # postgres|cockroachdb|mysql|spanner|memory
  logLevel: string           # info|debug|warn|error
  replicas: integer          # Number of SpiceDB pods

  tls:
    enabled: boolean
    secretName: string
    grpc: object
    http: object
    dispatch: object

  dispatch:
    enabled: boolean
    upstreamCASecretName: string

  migrations:
    enabled: boolean
    logLevel: string
    targetMigration: string
    targetPhase: string

aws:
  podIdentity:
    enabled: boolean
    roleArn: string        # IAM role ARN for Pod Identity association
    region: string

  rds:
    enabled: boolean
    hostname: string
    port: integer
    username: string       # IAM DB user
    database: string
    sslMode: string
    tokenRefresh:
      initContainer: boolean
      sidecar: boolean
      refreshInterval: duration

existingSecret: string
secretData:
  datastoreURI: string
  presharedKey: string

service:
  type: enum                 # ClusterIP|LoadBalancer|NodePort
  annotations: object

resources:
  limits: object
  requests: object

autoscaling:
  enabled: boolean
  minReplicas: integer
  maxReplicas: integer

podDisruptionBudget:
  enabled: boolean
  maxUnavailable: integer

monitoring:
  enabled: boolean
  serviceMonitor:
    enabled: boolean
```

## APIs and Integrations

### 1. Kubernetes API
- **ServiceAccount Token Projection:** For Pod Identity authentication
- **Endpoints API:** Service discovery for dispatch cluster
- **Events API:** Deployment status and diagnostics

### 2. AWS APIs (when Pod Identity enabled)
- **STS AssumeRole:** Pod Identity authentication via `pods.eks.amazonaws.com` service principal
- **RDS GenerateDBAuthToken:** IAM database authentication
- **Secrets Manager (optional):** Credential retrieval

### 3. SpiceDB APIs
- **gRPC API:** Primary authorization API (port 50051)
- **HTTP Gateway:** REST API (port 8443)
- **Metrics API:** Prometheus metrics (port 9090)
- **Dispatch API:** Inter-cluster communication (port 50053)

### 4. Database Connections
- **PostgreSQL:** Standard postgres:// connection string or RDS IAM
- **CockroachDB:** PostgreSQL protocol with additional parameters
- **MySQL:** Standard mysql:// connection string or RDS IAM
- **Cloud Spanner:** Service account credentials mounted as volume
- **Memory:** No external connection required

### 5. Certificate Management
- **Manual Certificates:** User-provided secrets
- **cert-manager Integration:** Automatic certificate issuance and renewal
- **CA Bundle Mounting:** Custom CA certificates for upstream TLS

## Infrastructure Requirements

### Kubernetes Cluster
- **Version:** 1.27+ (to match current support matrix)
- **RBAC:** Enabled (required for ServiceAccount permissions)
- **Admission Controllers:** ValidatingWebhook (optional, for validation)
- **Storage Class:** Not required (SpiceDB is stateless)

### AWS Infrastructure (for Pod Identity deployments)
- **EKS Cluster:** 1.28+ with EKS Pod Identity Agent installed
- **IAM Role:** Trust relationship with `pods.eks.amazonaws.com` service principal
- **EKS Pod Identity Association:** Maps ServiceAccount to IAM role
- **RDS Instance:** PostgreSQL 12+ or MySQL 8.0+ with IAM authentication enabled
- **VPC Configuration:** Security groups allowing EKS → RDS connectivity

### Database Requirements
- **PostgreSQL:** 12.0+ with `track_commit_timestamp = on` (for Watch API)
- **CockroachDB:** 21.1+ (minimum supported version)
- **MySQL:** 8.0+
- **Cloud Spanner:** Active GCP project with Spanner instance

### Monitoring Infrastructure
- **Prometheus:** For metrics collection (optional)
- **Prometheus Operator:** For ServiceMonitor support (optional)

### Network Requirements
- **Ingress Controller:** For external access (nginx, Contour, etc.)
- **Load Balancer:** For LoadBalancer service type
- **DNS:** CoreDNS or equivalent for service discovery

## Security Architecture

### Authentication
- **gRPC Preshared Key:** Symmetric key authentication
- **EKS Pod Identity:** AWS IAM role-based authentication
- **RDS IAM:** Temporary database credentials
- **Service Account Token:** Kubernetes API authentication

### Authorization
- **RBAC:** Kubernetes role-based access control
- **IAM Policies:** AWS resource access control
- **Database Grants:** Database-level permissions

### Encryption
- **TLS 1.2+:** All external communications
- **mTLS:** Dispatch cluster inter-pod communication
- **Secrets Encryption:** Kubernetes secrets encryption at rest
- **RDS Encryption:** Database encryption at rest

### Network Security
- **NetworkPolicy:** Pod-level network segmentation
- **Security Groups:** AWS VPC-level access control
- **Service Mesh (optional):** mTLS and traffic encryption

### Container Security
- **Non-root User:** Containers run as UID 1000
- **Read-only Root Filesystem:** Prevents container modification
- **Drop Capabilities:** Minimal Linux capabilities
- **Security Context:** Pod and container security policies

# Development Roadmap

## Phase 0: Test Infrastructure & Foundation (MVP-0)
**Goal:** Establish TDD framework and development tooling before writing any templates.

**Scope:**
- Install and configure helm-unittest plugin
- Create test directory structure (unit/, integration/, values/)
- Setup OPA/Conftest with base security policies
- Create CI/CD pipeline with automated testing
- Define JSON schema structure for values validation
- Write example test files demonstrating testing patterns
- Document TDD workflow for contributors

**Deliverables:**
- `.github/workflows/ci.yaml` - Automated test pipeline
- `tests/` directory with structure
- `policies/` directory with deny/warn policies
- `values.schema.json` skeleton
- `CONTRIBUTING.md` with TDD guidelines

**Success Criteria:**
- `helm unittest` runs successfully (even with no templates)
- CI pipeline executes lint, test, and policy checks
- OPA policies validate basic Kubernetes best practices

## Phase 1: Core Kubernetes Resources (MVP-1)
**Goal:** Deploy a minimal working SpiceDB instance using memory datastore (no external dependencies).

**Scope:**
- Helper templates (_helpers.tpl) with naming, labeling functions
- ServiceAccount with basic configuration
- RBAC (Role + RoleBinding) for endpoint discovery
- Secret generation for preshared key
- Service resource with all required ports
- Basic Deployment with memory datastore
- Health probes (liveness, readiness)
- NOTES.txt with connection instructions

**Test Coverage:**
- Unit tests for all helper functions
- ServiceAccount tests (labels, annotations, naming)
- RBAC tests (permissions, bindings)
- Service tests (port configuration, selectors)
- Deployment tests (basic configuration, probes, labels)
- Integration test: full deployment with memory datastore
- Snapshot tests for each resource

**Deliverables:**
- Working Helm chart that deploys SpiceDB in memory mode
- Comprehensive test suite (90%+ coverage)
- Example: `examples/dev-memory.yaml`

**Success Criteria:**
- `helm install` succeeds with default values
- SpiceDB pod reaches Ready state
- gRPC health check passes
- Can connect with zed CLI
- All tests passing in CI

## Phase 2: Datastore Integration (MVP-2)
**Goal:** Support PostgreSQL and CockroachDB datastores with proper configuration.

**Scope:**
- PostgreSQL datastore configuration
- CockroachDB datastore configuration
- Datastore-specific environment variables
- Connection string generation logic
- Secret management for datastore URIs
- External secret reference support (existingSecret pattern)
- Values.yaml design compatible with External Secrets Operator

**Test Coverage:**
- Deployment tests for PostgreSQL
- Deployment tests for CockroachDB
- Environment variable generation tests
- Secret mounting tests (both inline and existingSecret)
- Connection string format validation
- Snapshot tests for each datastore configuration
- External Secrets Operator compatibility tests

**Deliverables:**
- Support for PostgreSQL and CockroachDB
- CI values files: `ci/postgres-values.yaml`, `ci/cockroachdb-values.yaml`
- Examples: `examples/production-postgres.yaml`, `examples/production-cockroachdb.yaml`
- Example with External Secrets Operator: `examples/postgres-external-secrets.yaml`
- Documentation for each datastore setup
- Documentation for External Secrets Operator integration

**Success Criteria:**
- Can deploy with PostgreSQL
- Can deploy with CockroachDB
- Integration tests pass for both datastores on Minikube
- External Secrets Operator pattern documented and validated
- All datastore-specific tests passing

## Phase 3: Migration System (MVP-3)
**Goal:** Automated database migrations during install and upgrade operations.

**Scope:**
- Pre-install hook for initial migration
- Pre-upgrade hook for upgrade migrations
- Migration job template with proper configuration
- Migration hash tracking via annotations
- Support for target migration version
- Support for phased migrations
- Migration cleanup hooks
- Migration failure handling and rollback

**Test Coverage:**
- Migration job creation tests
- Hook annotation tests
- Environment variable tests for migrations
- Datastore-specific migration tests (PostgreSQL, CockroachDB)
- Target migration/phase tests
- Cleanup hook tests

**Deliverables:**
- Working migration system with Helm hooks
- Migration jobs for PostgreSQL and CockroachDB
- Phased migration support
- Examples with migration configuration
- Migration troubleshooting guide

**Success Criteria:**
- Migrations run automatically on install
- Migrations run automatically on upgrade
- Migration jobs complete successfully
- Cleanup hooks remove completed jobs
- Can specify target migration version
- All migration tests passing

## Phase 4: TLS & Security (MVP-4)
**Goal:** Comprehensive TLS support for all endpoints and production-ready security.

**Scope:**
- gRPC TLS configuration
- HTTP Gateway TLS configuration
- Dispatch cluster TLS (mTLS)
- Datastore TLS configuration
- Certificate mounting from secrets
- Separate TLS configuration per endpoint
- cert-manager integration examples
- Security contexts (non-root, read-only filesystem)
- Pod Security Standards compliance
- Capability dropping

**Test Coverage:**
- TLS secret mounting tests
- TLS environment variable tests
- Multi-TLS endpoint tests
- Security context tests
- Certificate path configuration tests
- Snapshot tests for TLS configurations

**Deliverables:**
- TLS support for all endpoints
- Security hardened deployment
- Example: `examples/production-cockroachdb-tls.yaml`
- cert-manager integration example
- Security audit documentation

**Success Criteria:**
- Can configure TLS for each endpoint independently
- Certificates properly mounted
- Health probes work with TLS
- Passes OPA security policies
- Containers run as non-root
- All TLS tests passing

## Phase 5: High Availability & Observability (MVP-5)
**Goal:** Production-ready HA configuration and monitoring integration.

**Scope:**
- PodDisruptionBudget with sensible defaults
- HorizontalPodAutoscaler configuration
- Pod anti-affinity rules
- Topology spread constraints
- ServiceMonitor for Prometheus Operator
- Metrics endpoint configuration
- Structured logging configuration
- Pod label/annotation projection
- Resource requests and limits
- Rolling update strategy (maxUnavailable: 0)

**Test Coverage:**
- PDB tests (maxUnavailable, selectors)
- HPA tests (min/max replicas, metrics)
- Affinity/anti-affinity tests
- ServiceMonitor tests
- Resource limit tests
- Rolling update tests
- Snapshot tests for HA configurations

**Deliverables:**
- Full HA configuration
- Prometheus integration
- Production-ready resource limits
- Example: `examples/production-ha.yaml`
- Observability documentation

**Success Criteria:**
- PDB prevents disruption during node maintenance
- HPA scales based on load
- Pods spread across availability zones
- ServiceMonitor created when Prometheus Operator present
- Zero downtime during rolling updates
- All HA tests passing

## Phase 6: Advanced Features & Polish (MVP-6)
**Goal:** Additional features and production hardening.

**Scope:**
- Ingress configuration (multiple controllers)
- NetworkPolicy templates
- Advanced dispatch configuration
- Telemetry configuration
- Performance tuning options

**Test Coverage:**
- Ingress tests for multiple controllers
- NetworkPolicy tests
- Advanced configuration tests

**Deliverables:**
- Ingress support for nginx, Contour, Traefik
- NetworkPolicy templates
- Advanced configuration examples
- Performance tuning guide

**Success Criteria:**
- Ingress works with major controllers
- NetworkPolicy properly segments traffic
- Advanced features documented
- All tests passing

## Phase 7: Post-MVP Enhancements (Future)

The following phases are deferred until after MVP completion:

### Phase 7a: Additional Datastores
- MySQL support
- Cloud Spanner support
- Memory mode (for dev/test)

### Phase 7b: AWS EKS Pod Identity Integration
**Prerequisites:** AWS testing environment available

**Scope:**
- ServiceAccount configuration for Pod Identity association
- RDS IAM token generation init container
- RDS IAM token refresh sidecar (optional)
- AWS region configuration
- RDS hostname/port/username configuration
- Connection string generation for RDS IAM
- Environment variables for AWS SDK
- ConfigMap for token generation scripts
- Documentation for EKS Pod Identity Agent installation
- Documentation for creating Pod Identity associations

### Phase 7c: StatefulSet Option
- StatefulSet deployment alternative
- Headless service
- Sticky identity use cases

## Phase 4: Migration System (MVP-4)
**Goal:** Automated database migrations during install and upgrade operations.

**Scope:**
- Pre-install hook for initial migration
- Pre-upgrade hook for upgrade migrations
- Migration job template with proper configuration
- Migration hash tracking via annotations
- Support for target migration version
- Support for phased migrations
- Migration cleanup hooks
- Pod Identity support in migration jobs
- Migration failure handling and rollback

**Test Coverage:**
- Migration job creation tests
- Hook annotation tests
- Environment variable tests for migrations
- Datastore-specific migration tests
- Target migration/phase tests
- Pod Identity in migration jobs tests
- Cleanup hook tests

**Deliverables:**
- Working migration system with Helm hooks
- Migration jobs for all datastores
- Phased migration support
- Examples with migration configuration
- Migration troubleshooting guide

**Success Criteria:**
- Migrations run automatically on install
- Migrations run automatically on upgrade
- Migration jobs complete successfully
- Cleanup hooks remove completed jobs
- Can specify target migration version
- All migration tests passing

## Phase 5: TLS & Security (MVP-5)
**Goal:** Comprehensive TLS support for all endpoints and production-ready security.

**Scope:**
- gRPC TLS configuration
- HTTP Gateway TLS configuration
- Dispatch cluster TLS (mTLS)
- Datastore TLS configuration
- Certificate mounting from secrets
- Separate TLS configuration per endpoint
- cert-manager integration examples
- Security contexts (non-root, read-only filesystem)
- Pod Security Standards compliance
- Capability dropping

**Test Coverage:**
- TLS secret mounting tests
- TLS environment variable tests
- Multi-TLS endpoint tests
- Security context tests
- Certificate path configuration tests
- Snapshot tests for TLS configurations

**Deliverables:**
- TLS support for all endpoints
- Security hardened deployment
- Example: `examples/production-cockroachdb-tls.yaml`
- cert-manager integration example
- Security audit documentation

**Success Criteria:**
- Can configure TLS for each endpoint independently
- Certificates properly mounted
- Health probes work with TLS
- Passes OPA security policies
- Containers run as non-root
- All TLS tests passing

## Phase 6: High Availability & Observability (MVP-6)
**Goal:** Production-ready HA configuration and monitoring integration.

**Scope:**
- PodDisruptionBudget with sensible defaults
- HorizontalPodAutoscaler configuration
- Pod anti-affinity rules
- Topology spread constraints
- ServiceMonitor for Prometheus Operator
- Metrics endpoint configuration
- Structured logging configuration
- Pod label/annotation projection
- Resource requests and limits
- Rolling update strategy (maxUnavailable: 0)

**Test Coverage:**
- PDB tests (maxUnavailable, selectors)
- HPA tests (min/max replicas, metrics)
- Affinity/anti-affinity tests
- ServiceMonitor tests
- Resource limit tests
- Rolling update tests
- Snapshot tests for HA configurations

**Deliverables:**
- Full HA configuration
- Prometheus integration
- Production-ready resource limits
- Example: `examples/production-ha.yaml`
- Observability documentation

**Success Criteria:**
- PDB prevents disruption during node maintenance
- HPA scales based on load
- Pods spread across availability zones
- ServiceMonitor created when Prometheus Operator present
- Zero downtime during rolling updates
- All HA tests passing

## Phase 7: Advanced Features & Polish (Post-MVP)
**Goal:** Additional features and production hardening.

**Scope:**
- Ingress configuration (multiple controllers)
- NetworkPolicy templates
- StatefulSet option (alternative to Deployment)
- Headless service for StatefulSet
- AWS Secrets Manager integration
- Custom patches support (post-renderer)
- Advanced dispatch configuration
- Telemetry configuration
- Multi-cluster dispatch
- Performance tuning options

**Test Coverage:**
- Ingress tests for multiple controllers
- NetworkPolicy tests
- StatefulSet tests
- Secrets Manager tests
- Advanced configuration tests

**Deliverables:**
- Ingress support for nginx, Contour, Traefik
- NetworkPolicy templates
- StatefulSet deployment option
- Advanced configuration examples
- Performance tuning guide

**Success Criteria:**
- Ingress works with major controllers
- NetworkPolicy properly segments traffic
- StatefulSet option functional
- Advanced features documented
- All tests passing

# Logical Dependency Chain

## Foundation Layer (Must Build First)
1. **Test Infrastructure (Phase 0)**
   - Required before any template development
   - Enables TDD workflow
   - Prevents regression
   - Gates: CI pipeline operational

2. **Helper Templates (Phase 1)**
   - All other templates depend on helpers
   - Naming conventions
   - Label generation
   - Gates: Helper function tests passing

3. **ServiceAccount + RBAC (Phase 1)**
   - Required for deployment
   - Foundation for IRSA
   - Gates: Can create SA and bind roles

## Core Functionality Layer (Quickly Usable)
4. **Basic Deployment with Memory (Phase 1)**
   - First usable deliverable
   - No external dependencies
   - Proves chart works end-to-end
   - Gates: Can install, connect, test

5. **Service Resource (Phase 1)**
   - Required for deployment to be accessible
   - Gates: Service created with correct ports

6. **Secret Management (Phase 1)**
   - Required for production datastores
   - Gates: Secrets mounted correctly

## Datastore Layer (Horizontal Expansion)
7. **PostgreSQL Support (Phase 2)**
   - Most common production datastore
   - Gates: Can deploy with Postgres

8. **Other Datastores (Phase 2)**
   - CockroachDB, MySQL, Spanner
   - Independent from each other
   - Can be developed in parallel
   - Gates: Each datastore validated independently

## AWS Integration Layer (Critical for Target Users)
9. **Pod Identity Foundation (Phase 3)**
   - Builds on ServiceAccount from Phase 1
   - Required before RDS IAM
   - Requires EKS Pod Identity Agent installed
   - Gates: ServiceAccount configured, Pod Identity association created

10. **RDS IAM Token Generation (Phase 3)**
    - Depends on Pod Identity foundation
    - Init container approach (simpler)
    - Gates: Token generated successfully

11. **Token Refresh Sidecar (Phase 3)**
    - Enhancement to init container
    - Can be optional
    - Gates: Token refreshes before expiration

## Migration Layer (Critical for Upgrades)
12. **Basic Migration Hooks (Phase 4)**
    - Depends on basic deployment working
    - Pre-install hook (initial migration)
    - Gates: Migration runs on install

13. **Upgrade Migrations (Phase 4)**
    - Pre-upgrade hook
    - Depends on basic migration working
    - Gates: Migration runs on upgrade

14. **Migration with Pod Identity (Phase 4)**
    - Combines Phase 3 and Phase 4
    - Gates: Migrations work with RDS IAM

15. **Phased Migrations (Phase 4)**
    - Enhancement to basic migrations
    - Gates: Multi-phase migrations work

## Security Layer (Production Hardening)
16. **Basic TLS (Phase 5)**
    - gRPC TLS first (most critical)
    - Gates: Can connect with TLS

17. **Multi-Endpoint TLS (Phase 5)**
    - HTTP, dispatch, datastore TLS
    - Independent configurations
    - Gates: Each endpoint encrypted

18. **Security Contexts (Phase 5)**
    - Can be developed in parallel with TLS
    - Gates: Passes security policies

## High Availability Layer (Production Scale)
19. **PodDisruptionBudget (Phase 6)**
    - Depends on multi-replica deployment
    - Gates: Disruptions prevented

20. **HPA (Phase 6)**
    - Depends on resource limits being set
    - Gates: Scales up and down

21. **Affinity Rules (Phase 6)**
    - Enhancement to deployment
    - Gates: Pods spread across zones

22. **Monitoring (Phase 6)**
    - Independent from HA features
    - Gates: Metrics scraped successfully

## Polish Layer (Post-MVP)
23. **Ingress (Phase 7)**
    - Depends on Service and TLS
    - Multiple controller support
    - Gates: External access working

24. **NetworkPolicy (Phase 7)**
    - Enhancement to security
    - Gates: Traffic properly segmented

25. **Advanced Features (Phase 7)**
    - Various enhancements
    - Can be prioritized based on feedback

## Pacing Strategy

**Weeks 1-2: Foundation + Quick Win**
- Build test infrastructure
- Complete Phase 1 (memory deployment)
- **Milestone:** Working chart that can be installed and tested

**Weeks 3-4: Production Datastores + AWS**
- Complete Phase 2 (all datastores)
- Complete Phase 3 (EKS Pod Identity)
- **Milestone:** Production-ready for AWS EKS users with RDS

**Week 5: Migrations**
- Complete Phase 4 (migration system)
- **Milestone:** Safe upgrades possible

**Week 6: Security + HA**
- Complete Phase 5 (TLS)
- Complete Phase 6 (HA/monitoring)
- **Milestone:** Enterprise-ready deployment

**Post-Week 6: Polish**
- Phase 7 features based on feedback
- Documentation improvements
- Community contributions

# Risks and Mitigations

## Technical Challenges

### Risk 1: Migration Complexity
**Impact:** High - Failed migrations can corrupt data or cause downtime
**Probability:** Medium

**Mitigations:**
- Extensive testing of migration hooks with all datastores
- Document migration paths and known issues
- Provide rollback procedures
- Test with spicedb-operator examples as reference
- Implement migration dry-run support
- Add pre-migration validation hooks

### Risk 2: RDS Token Expiration
**Impact:** Medium - RDS tokens expire after 15 minutes
**Probability:** Medium for long-running pods

**Mitigations:**
- Implement token refresh sidecar option
- Document token lifetime limitations
- Add monitoring for authentication failures
- Provide clear error messages for token expiration
- Consider connection pooling strategies
- Test with EKS Pod Identity Agent for improved scalability

### Risk 3: TLS Certificate Rotation
**Impact:** Medium - Expired certificates cause service disruption
**Probability:** Low with proper setup

**Mitigations:**
- Document cert-manager integration for auto-renewal
- Add validation for certificate expiration dates
- Provide monitoring alerts for expiring certificates
- Test certificate rotation scenarios
- Document manual rotation procedures

### Risk 4: Version Compatibility
**Impact:** High - Incompatible SpiceDB versions can break deployments
**Probability:** Medium during upgrades

**Mitigations:**
- Document tested version combinations
- Implement schema validation for version compatibility
- Provide upgrade path documentation
- Test major version upgrades in CI
- Reference spicedb-operator update graph

### Risk 5: Datastore-Specific Issues
**Impact:** Medium - Each datastore has unique requirements
**Probability:** Medium

**Mitigations:**
- Extensive testing with each datastore
- Document datastore-specific configuration
- Provide validated examples for each
- CI testing with real database instances
- Community feedback on production usage

## MVP Scoping Challenges

### Risk 6: Feature Creep
**Impact:** High - Delayed initial release
**Probability:** High

**Mitigations:**
- Strict MVP definition: memory deployment first
- Phase-based development with clear gates
- Defer advanced features to post-MVP
- Focus on 80% use cases
- Community feedback drives post-MVP priorities

### Risk 7: Test Coverage Gaps
**Impact:** Medium - Bugs in production
**Probability:** Medium

**Mitigations:**
- TDD approach from start
- 90%+ test coverage requirement
- Snapshot testing for complex configurations
- OPA policies for security validation
- Manual testing checklist for each phase

### Risk 8: Documentation Lag
**Impact:** Medium - Poor adoption due to unclear usage
**Probability:** High

**Mitigations:**
- Documentation as part of definition of done
- Examples for each major feature
- NOTES.txt provides immediate guidance
- Video walkthroughs for complex setups
- FAQ based on operator issues

## Resource Constraints

### Risk 9: AWS-Specific Testing
**Impact:** Medium - Cannot fully test Pod Identity without EKS
**Probability:** Medium

**Mitigations:**
- Mock Pod Identity testing with ServiceAccount configuration
- Partner with early adopters for EKS testing
- Document AWS setup requirements clearly (including Pod Identity Agent)
- Provide troubleshooting guide for Pod Identity
- Test locally with AWS CLI commands for token generation
- Document differences between IRSA and Pod Identity for migration

### Risk 10: Multiple Datastore Testing
**Impact:** Medium - Cannot test all datastores continuously
**Probability:** Medium

**Mitigations:**
- Memory and PostgreSQL in CI (always)
- Periodic testing with CockroachDB, MySQL
- Community contributions for Spanner testing
- Document known limitations per datastore
- Snapshot testing reduces need for live testing

### Risk 11: Kubernetes Version Compatibility
**Impact:** Low - Chart may not work on older clusters
**Probability:** Low

**Mitigations:**
- Target Kubernetes 1.27+ (current LTS)
- Test on multiple K8s versions in CI
- Document minimum version requirements
- Use stable API versions
- Avoid bleeding-edge features

## Adoption Risks

### Risk 12: Operator Migration Path
**Impact:** Medium - Users want to migrate from operator
**Probability:** Medium

**Mitigations:**
- Document migration from operator to Helm
- Provide value mapping guide
- Test migration scenarios
- Explain feature parity differences
- Consider operator-to-helm migration tool

### Risk 13: Community Maintenance
**Impact:** High - Chart becomes stale without maintenance
**Probability:** Medium

**Mitigations:**
- Clear contribution guidelines
- Automated testing reduces review burden
- Regular dependency updates (Dependabot)
- Active issue triage and response
- Maintainer documentation

# Appendix

## Research Findings

### spicedb-operator Analysis
**Source:** https://github.com/authzed/spicedb-operator

**Key Findings:**
- Operator manages SpiceDBCluster CRD
- Supports 5 datastores: postgres, cockroachdb, mysql, spanner, memory
- Automated migrations via controller reconciliation
- Update channels for version management
- Patch system for advanced customization
- Status reporting via CRD status field

**Features Not Replicable in Helm:**
- Automatic update channels (requires controller)
- Dynamic status reporting (requires reconciliation loop)
- Automatic rollback on failure (requires controller)
- Patch validation before apply (requires validation webhook)

**Features Replicable in Helm:**
- All deployment configurations
- Migration execution (via hooks)
- TLS configuration
- RBAC setup
- Multi-datastore support
- Resource patching (via post-renderer)

### helm-unittest Research
**Source:** https://github.com/helm-unittest/helm-unittest

**Key Capabilities:**
- BDD-style test syntax
- Snapshot testing
- Document selectors for multi-doc templates
- JsonPath assertions
- Subchart testing
- CI integration with JUnit output

**Best Practices Applied:**
- Test files in `tests/` directory
- Naming convention: `*_test.yaml`
- Test organization: unit/, integration/, values/
- Snapshot updates: `helm unittest -u`
- CI integration: `helm unittest -t junit`

### OPA/Conftest Research
**Source:** https://www.conftest.dev/, https://nearform.com/digital-community/opa-policy-based-testing-of-helm-charts/

**Policy Patterns:**
- deny: Hard failures (security violations)
- warn: Soft failures (best practice deviations)
- violation: Compliance issues

**Applied Policies:**
- Deny privileged containers
- Deny latest image tags
- Deny missing resource limits
- Warn on missing labels
- Warn on missing probes
- Validate Pod Identity configuration

### AWS EKS Pod Identity Research
**Sources:** AWS EKS documentation, AWS IAM documentation, AWS blogs

**Requirements:**
- EKS cluster 1.28+ (platform version eks.4 or later)
- EKS Pod Identity Agent deployed in cluster
- IAM role with trust relationship to `pods.eks.amazonaws.com`
- EKS Pod Identity association mapping ServiceAccount to IAM role
- RDS instance with IAM authentication enabled
- Database user with rds_iam role (PostgreSQL)
- Linux EC2 worker nodes (not supported on Fargate or Windows)

**Key Differences from IRSA:**
- No OIDC provider required (simpler cluster setup)
- Uses `pods.eks.amazonaws.com` service principal (reusable across clusters)
- Credentials fetched once per node (improved scalability)
- Configuration via EKS API/CLI (not ServiceAccount annotations)
- Requires EKS Pod Identity Agent installation

**Token Characteristics:**
- 15-minute lifetime (same as IRSA)
- Generated via `aws rds generate-db-auth-token`
- Used as password in connection string
- Requires SSL connection

**Best Practices:**
- Install Pod Identity Agent once per cluster
- Use init container for short-lived jobs
- Use sidecar for long-running deployments
- Refresh tokens before expiration (10-minute interval)
- Monitor authentication failures
- Document Pod Identity association creation in deployment guide

## Technical Specifications

### Supported SpiceDB Versions
- Minimum: v1.22.0 (baseline features)
- Tested: v1.22.0, v1.23.0, v1.24.0, latest
- Migration compatibility: All v1.x migrations

### Supported Kubernetes Versions
- Minimum: 1.27 (current LTS)
- Tested: 1.27, 1.28, 1.29, 1.30
- API versions used: apps/v1, batch/v1, core/v1, policy/v1

### Supported Datastores
| Datastore    | Minimum Version | Notes                          |
|--------------|-----------------|--------------------------------|
| PostgreSQL   | 12.0            | Requires track_commit_timestamp |
| CockroachDB  | 21.1            | Recommended 22.1+              |
| MySQL        | 8.0             | InnoDB required                |
| Spanner      | N/A             | GCP managed service            |
| Memory       | N/A             | Development only               |

### AWS EKS Pod Identity Compatibility
- EKS versions: 1.28+ (platform version eks.4 or later)
- EKS Pod Identity Agent: Required, installed via add-on
- RDS PostgreSQL: 12.0+ with IAM auth enabled
- RDS MySQL: 8.0+ with IAM auth enabled
- IAM role trust: `pods.eks.amazonaws.com` service principal
- Worker nodes: Linux EC2 only (not Fargate or Windows)

### Resource Requirements

**Minimum (Development):**
- CPU: 100m
- Memory: 256Mi
- Replicas: 1

**Recommended (Production):**
- CPU: 500m (request), 2000m (limit)
- Memory: 1Gi (request), 4Gi (limit)
- Replicas: 3 (HA)

**Large Scale:**
- CPU: 2000m (request), 4000m (limit)
- Memory: 4Gi (request), 8Gi (limit)
- Replicas: 5-10 with HPA

### Test Coverage Metrics

**Target Coverage:**
- Unit tests: 90%+
- Integration tests: 80%+
- Security policies: 100% of critical rules

**Test Categories:**
- Template rendering: 150+ tests
- Configuration variants: 50+ tests
- Integration scenarios: 20+ tests
- Security policies: 15+ rules

### Performance Benchmarks

**Chart Operations:**
- `helm template`: <5 seconds
- `helm install`: <30 seconds (memory mode)
- `helm install`: <2 minutes (with migration)
- `helm upgrade`: <3 minutes (with migration)
- Test suite: <30 seconds

## Definition of Done

**Per Phase:**
- [ ] All templates implemented
- [ ] Test coverage meets targets (90%+)
- [ ] OPA policies passing
- [ ] Documentation written
- [ ] Examples provided
- [ ] CI tests passing
- [ ] Code review completed
- [ ] Manual testing completed

**Final Release:**
- [ ] All phases complete
- [ ] Chart passes `helm lint`
- [ ] All tests passing in CI
- [ ] Security audit completed
- [ ] Documentation complete
- [ ] Examples validated
- [ ] Migration guide written
- [ ] Community review completed
- [ ] Performance benchmarks met

## Decisions Made

### Chart Publishing
**Decision:** GitHub Packages (OCI registry)
- Primary distribution via GitHub Container Registry (ghcr.io)
- Secondary listing on ArtifactHub for discoverability
- Independent semantic versioning (chart version != SpiceDB version)
- Chart appVersion tracks SpiceDB version

### Testing Strategy
**Decision:** Minikube/Kind first, EKS Pod Identity later
- MVP testing on Minikube with PostgreSQL
- Pod Identity implementation deferred to post-MVP
- Focus on core functionality with standard Kubernetes secrets
- Pod Identity can be added in future iterations when AWS testing available

### Datastore Support Priority
**Decision:** PostgreSQL and CockroachDB only for MVP
- **Phase 2 Scope:** PostgreSQL (primary), CockroachDB (secondary)
- **Post-MVP:** MySQL, Spanner, Memory (if requested)
- Rationale: Cover 90% of production use cases, keep scope manageable

### Secret Management Approach
**Decision:** Kubernetes Secrets with External Secrets Operator compatibility
- Use native Kubernetes Secrets as primary mechanism
- Design values.yaml to be compatible with External Secrets Operator
- Users can inject secrets via ESO, Sealed Secrets, or other tools
- No built-in AWS Secrets Manager or IRSA/Pod Identity in MVP
- Pod Identity support can be added post-MVP without breaking changes

### Deployment Type
**Decision:** Deployment as default (StatefulSet optional post-MVP)
- SpiceDB is stateless, Deployment is appropriate
- StatefulSet not needed for MVP
- Can add as alternative template in Phase 7 if needed

### Governance
**Decision:** Standard open-source model
- Maintainer: Initial team (you/your organization)
- Contributions: GitHub PR workflow with TDD requirements
- Versioning: Semantic versioning with 2-version deprecation window

## Open Questions (Remaining)

None - all critical decisions made for MVP implementation.

## Out of Scope for MVP

The following features are explicitly deferred to post-MVP phases:

1. **AWS EKS Pod Identity Integration**
   - Deferred until AWS testing environment available
   - Will be added as Phase 8 (post-MVP)
   - Values.yaml structure designed to accommodate future addition

2. **Additional Datastores**
   - MySQL (deferred)
   - Cloud Spanner (deferred)
   - Memory mode (deferred - use PostgreSQL for dev/test)

3. **IRSA Support**
   - Not needed (Pod Identity is future direction)
   - No migration path required

4. **AWS Secrets Manager Integration**
   - Users can achieve this via External Secrets Operator
   - No native integration needed

5. **StatefulSet Deployment**
   - Deployment sufficient for stateless SpiceDB
   - Can add if community requests

</PRD>
