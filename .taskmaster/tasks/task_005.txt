# Task ID: 5
# Title: Implement Comprehensive TLS Support for All Endpoints
# Status: done
# Dependencies: 4
# Priority: high
# Description: Add TLS configuration for gRPC, HTTP gateway, dispatch cluster, and datastore connections with cert-manager integration
# Details:
Extend values.yaml with tls.enabled, tls.grpc (secretName, certPath, keyPath, caPath), tls.http (same structure), tls.dispatch (secretName, certPath, keyPath, caPath for mTLS), tls.datastore (secretName, caPath). Update templates/deployment.yaml to mount TLS secrets as volumes when enabled. Add TLS environment variables: SPICEDB_GRPC_TLS_CERT_PATH, SPICEDB_GRPC_TLS_KEY_PATH, SPICEDB_GRPC_TLS_CA_PATH for gRPC. Add SPICEDB_HTTP_TLS_CERT_PATH, SPICEDB_HTTP_TLS_KEY_PATH for HTTP gateway. Add SPICEDB_DISPATCH_CLUSTER_TLS_CERT_PATH, SPICEDB_DISPATCH_CLUSTER_TLS_KEY_PATH, SPICEDB_DISPATCH_CLUSTER_TLS_CA_PATH for dispatch mTLS. Update datastore connection string to include sslmode=verify-full, sslrootcert, sslcert, sslkey when tls.datastore enabled. Update readiness/liveness probes to use HTTPS scheme when TLS enabled. Harden security context: capabilities.drop [ALL], allowPrivilegeEscalation: false, seccompProfile.type: RuntimeDefault. Create examples/production-cockroachdb-tls.yaml with full TLS configuration. Create examples/cert-manager-integration.yaml demonstrating Certificate CRD usage. Document cert-manager integration: Certificate resource, Issuer/ClusterIssuer, automatic renewal.

# Test Strategy:
TLS secret mounting tests verify volumes created for each TLS type. TLS environment variable tests verify correct paths for gRPC, HTTP, dispatch, datastore. Multi-TLS endpoint tests: enable all TLS types, verify all environment variables and volumes present. Security context tests verify non-root user, read-only filesystem, dropped capabilities. Certificate path configuration tests verify custom paths override defaults. Snapshot tests for full TLS configuration. Integration test: deploy with self-signed certificates, verify TLS connections work. Probe tests: verify readiness/liveness probes use HTTPS when TLS enabled. OPA policy tests: verify deployment passes Pod Security Standards restricted profile. cert-manager integration test: deploy with Certificate CRD, verify secret created and mounted.

# Subtasks:
## 1. Extend values.yaml with TLS configuration structure for all endpoints [done]
### Dependencies: None
### Description: Add comprehensive TLS configuration options to values.yaml for gRPC, HTTP gateway, dispatch cluster, and datastore endpoints with certificate path configurations
### Details:
Add tls.enabled (global toggle), tls.grpc object with secretName, certPath, keyPath, caPath fields. Add tls.http object with secretName, certPath, keyPath fields. Add tls.dispatch object with secretName, certPath, keyPath, caPath for mTLS support. Add tls.datastore object with secretName, caPath for database connection encryption. Include sensible defaults for certificate paths (/etc/spicedb/tls/) and document each field with inline comments explaining purpose and usage.
<info added on 2025-11-08T05:03:23.311Z>
Configuration successfully added with 120 lines of comprehensive TLS structure in values.yaml (lines 108-227). Implemented global toggle (tls.enabled), gRPC server TLS (secretName, certPath, keyPath, caPath), HTTP server TLS (secretName, certPath, keyPath), dispatch cluster mTLS (secretName, certPath, keyPath, caPath), and datastore client TLS (secretName, caPath). All paths use /etc/spicedb/tls/ prefix with endpoint-specific subdirectories. Included inline documentation explaining purpose, secret structure requirements, cert-manager integration examples, and mTLS vs server TLS differences. Configuration maintains existing values.yaml 2-space indentation style and is positioned between config.datastore (line 106) and migrations (line 229) sections.
</info added on 2025-11-08T05:03:23.311Z>

## 2. Implement TLS secret mounting logic in deployment.yaml [done]
### Dependencies: 5.1
### Description: Add conditional volume and volumeMount configurations to deployment.yaml template for mounting TLS secrets when TLS is enabled for any endpoint
### Details:
Add volumes section with conditional blocks using {{ if .Values.tls.grpc.secretName }}, {{ if .Values.tls.http.secretName }}, {{ if .Values.tls.dispatch.secretName }}, {{ if .Values.tls.datastore.secretName }}. Each volume references the corresponding secret and mounts to /etc/spicedb/tls/{grpc,http,dispatch,datastore}. Add volumeMounts in container spec pointing to these paths. Ensure volume names are unique (e.g., tls-grpc-certs, tls-http-certs, tls-dispatch-certs, tls-datastore-certs) and mount paths align with certificate path values.

## 3. Add gRPC TLS environment variables and configuration [done]
### Dependencies: 5.2
### Description: Configure gRPC endpoint TLS by adding environment variables for certificate paths and enabling TLS in SpiceDB gRPC server configuration
### Details:
Add conditional environment variables in deployment.yaml when .Values.tls.grpc.secretName is set: SPICEDB_GRPC_TLS_CERT_PATH pointing to {{ .Values.tls.grpc.certPath }}, SPICEDB_GRPC_TLS_KEY_PATH pointing to {{ .Values.tls.grpc.keyPath }}, SPICEDB_GRPC_TLS_CA_PATH pointing to {{ .Values.tls.grpc.caPath }}. Ensure paths reference mounted volume locations. Set default paths to /etc/spicedb/tls/grpc/tls.crt, /etc/spicedb/tls/grpc/tls.key, /etc/spicedb/tls/grpc/ca.crt in values.yaml.

## 4. Add HTTP gateway TLS environment variables and configuration [done]
### Dependencies: 5.2
### Description: Configure HTTP gateway endpoint TLS by adding environment variables for certificate and key paths
### Details:
Add conditional environment variables in deployment.yaml when .Values.tls.http.secretName is set: SPICEDB_HTTP_TLS_CERT_PATH pointing to {{ .Values.tls.http.certPath }}, SPICEDB_HTTP_TLS_KEY_PATH pointing to {{ .Values.tls.http.keyPath }}. Note that HTTP gateway typically does not require CA certificate for server TLS. Set default paths to /etc/spicedb/tls/http/tls.crt and /etc/spicedb/tls/http/tls.key in values.yaml.

## 5. Add dispatch cluster mTLS configuration with CA certificate support [done]
### Dependencies: 5.2
### Description: Configure mutual TLS for dispatch cluster communication with certificate, key, and CA certificate paths for inter-pod authentication
### Details:
Add conditional environment variables in deployment.yaml when .Values.tls.dispatch.secretName is set: SPICEDB_DISPATCH_CLUSTER_TLS_CERT_PATH pointing to {{ .Values.tls.dispatch.certPath }}, SPICEDB_DISPATCH_CLUSTER_TLS_KEY_PATH pointing to {{ .Values.tls.dispatch.keyPath }}, SPICEDB_DISPATCH_CLUSTER_TLS_CA_PATH pointing to {{ .Values.tls.dispatch.caPath }}. Dispatch requires mTLS for secure inter-pod communication, so all three certificate types (cert, key, CA) are mandatory. Set default paths to /etc/spicedb/tls/dispatch/ directory.

## 6. Update datastore connection strings for TLS support [done]
### Dependencies: 5.2
### Description: Modify PostgreSQL and CockroachDB connection string generation to include SSL parameters when datastore TLS is enabled
### Details:
Update SPICEDB_DATASTORE_CONN_URI environment variable generation in deployment.yaml to append SSL parameters when .Values.tls.datastore.secretName is set. For PostgreSQL: append ?sslmode=verify-full&sslrootcert={{ .Values.tls.datastore.caPath }}. For CockroachDB: append ?sslmode=verify-full&sslrootcert={{ .Values.tls.datastore.caPath }}. If client certificates required, add &sslcert={{ .Values.tls.datastore.certPath }}&sslkey={{ .Values.tls.datastore.keyPath }}. Handle connection string templating to avoid duplicate parameters.

## 7. Update probes to use HTTPS and harden security context [done]
### Dependencies: 5.3, 5.4
### Description: Modify readiness and liveness probes to use HTTPS scheme when TLS enabled and implement Pod Security Standards restricted profile requirements
### Details:
Update httpGet probes in deployment.yaml to conditionally use scheme: HTTPS when .Values.tls.http.secretName or .Values.tls.grpc.secretName is set (probes target HTTP gateway). Add securityContext to container spec: capabilities.drop [ALL], allowPrivilegeEscalation: false, readOnlyRootFilesystem: true (if supported), runAsNonRoot: true, seccompProfile.type: RuntimeDefault. Add pod-level securityContext: fsGroup: 1000, runAsUser: 1000, runAsGroup: 1000 for non-root execution.

## 8. Create production TLS examples and cert-manager integration documentation [done]
### Dependencies: 5.1, 5.3, 5.4, 5.5, 5.6, 5.7
### Description: Create example configurations demonstrating production TLS setup with CockroachDB and cert-manager integration for automated certificate management
### Details:
Create examples/production-cockroachdb-tls.yaml showing complete TLS configuration for all endpoints (gRPC, HTTP, dispatch, datastore) with CockroachDB backend using certificate secrets. Create examples/cert-manager-integration.yaml demonstrating Certificate CRD usage with cert-manager.io/v1 API, showing Issuer/ClusterIssuer configuration, Certificate resources for each endpoint, and automatic secret creation. Document in values.yaml comments: cert-manager integration steps, Certificate resource format, automatic renewal behavior, and recommended Issuer configuration for production.

