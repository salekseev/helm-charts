# Task ID: 9
# Title: Implement Ingress and NetworkPolicy Support
# Status: done
# Dependencies: 8
# Priority: low
# Description: Add Ingress configuration for multiple controllers and NetworkPolicy templates for network segmentation
# Details:
Create templates/ingress.yaml supporting multiple ingress controllers: nginx (kubernetes.io/ingress.class), Contour (projectcontour.io/ingress.class), Traefik (traefik.ingress.kubernetes.io/router.entrypoints). Support Ingress API versions: networking.k8s.io/v1 (default), with backward compatibility checks. Configuration via ingress.enabled, ingress.className, ingress.annotations, ingress.hosts (array with host, paths), ingress.tls (array with secretName, hosts). Support path types: Prefix, Exact, ImplementationSpecific. Support multiple hosts and paths. Create templates/networkpolicy.yaml with: ingress rules allowing traffic from ingress controller to SpiceDB ports (50051, 8443), ingress rules allowing inter-pod communication on dispatch port (50053), egress rules allowing DNS (port 53), datastore connectivity, Kubernetes API. Make NetworkPolicy optional via networkPolicy.enabled (default false). Add networkPolicy.ingress and networkPolicy.egress for custom rules. Create examples/production-ingress-nginx.yaml, examples/production-ingress-contour.yaml. Document Ingress setup for each controller type, TLS termination options (at ingress vs passthrough), NetworkPolicy security benefits and limitations.
<info added on 2025-11-08T14:48:07.926Z>
Based on analyzing the research session about creating integration tests for SpiceDB Helm chart with Kind and PostgreSQL, here's the new information that should be appended to Task 9 (Ingress and NetworkPolicy Support):

Integration tests should include verification of Ingress and NetworkPolicy functionality in Kind cluster environment. Deploy PostgreSQL using official postgres:16 container image via kubectl manifests (tests/integration/postgres-deployment.yaml) with PVC-backed storage. Test Ingress routing to SpiceDB gRPC (50051) and HTTP (8443) ports with sample permission checks using zed CLI. Verify NetworkPolicy rules allow traffic from ingress controller namespace to SpiceDB pods while blocking unauthorized access. Integration test script (tests/integration/ingress-networkpolicy-test.sh) should deploy postgres, install chart with ingress.enabled=true and networkPolicy.enabled=true, load test schema, verify external access via ingress hostname, test NetworkPolicy enforcement by attempting blocked connections, verify cleanup. Include tests for each supported ingress controller (nginx, Contour) with controller-specific annotations. Test TLS termination by deploying self-signed certificates and verifying HTTPS access. NetworkPolicy verification should confirm DNS egress works, datastore connectivity allowed, inter-pod dispatch traffic permitted on port 50053, and unauthorized egress blocked. Leverage existing test infrastructure from Task 1 and migration testing patterns including Kind cluster lifecycle, helm install/upgrade workflows, and data persistence verification across updates.
</info added on 2025-11-08T14:48:07.926Z>

# Test Strategy:
Ingress tests verify correct apiVersion (networking.k8s.io/v1). Ingress className tests verify ingressClassName field set correctly. Ingress annotation tests for nginx, Contour, Traefik specific annotations. Ingress host/path tests verify multiple hosts and paths supported. Ingress TLS tests verify tls section with secretName and hosts. NetworkPolicy ingress tests verify rules allow traffic on SpiceDB ports. NetworkPolicy egress tests verify rules allow DNS and datastore connectivity. NetworkPolicy inter-pod tests verify dispatch port allowed. Snapshot tests for Ingress with each controller. Snapshot tests for NetworkPolicy. Integration test: deploy with nginx ingress, create Ingress resource, verify external access via hostname. Integration test: deploy with NetworkPolicy, verify policy applied, verify allowed traffic works, verify blocked traffic denied.

# Subtasks:
## 1. Create Ingress template supporting multiple controllers [done]
### Dependencies: None
### Description: Implement templates/ingress.yaml with support for nginx, Contour, and Traefik ingress controllers using networking.k8s.io/v1 API
### Details:
Create templates/ingress.yaml with apiVersion networking.k8s.io/v1. Add conditional rendering based on ingress.enabled. Support ingressClassName field for controller selection. Add controller-specific annotations: kubernetes.io/ingress.class for nginx, projectcontour.io/ingress.class for Contour, traefik.ingress.kubernetes.io/router.entrypoints for Traefik. Include values.yaml fields: ingress.enabled (default false), ingress.className, ingress.annotations (map for custom annotations). Implement backward compatibility checks for older Kubernetes versions if needed.
<info added on 2025-11-08T14:51:46.120Z>
Implementation completed and verified. Ingress template successfully supports multiple controllers (nginx, Contour, Traefik) with flexible configuration for hosts, paths, TLS, and annotations. Schema validation ensures proper configuration structure. Comprehensive testing confirms all functionality including named/numeric ports, multi-host setups, and controller-specific features. Examples provided for common use cases including cert-manager integration.
</info added on 2025-11-08T14:51:46.120Z>

## 2. Implement multi-host and multi-path support with configurable path types [done]
### Dependencies: 9.1
### Description: Add support for multiple hosts, paths, and configurable path types (Prefix, Exact, ImplementationSpecific) in Ingress template
### Details:
Extend templates/ingress.yaml to iterate over ingress.hosts array. Each host entry contains host and paths array. Each path entry contains path string, pathType (Prefix/Exact/ImplementationSpecific), and backend service configuration. Backend references SpiceDB service name and appropriate port (gRPC 50051 or HTTP 8443). Add values.yaml structure: ingress.hosts as array with host, paths (array with path, pathType, port). Support multiple hosts with different path configurations. Default pathType to Prefix if not specified.

## 3. Add TLS configuration for Ingress with certificate references [done]
### Dependencies: 9.2
### Description: Implement TLS termination configuration in Ingress template with support for multiple hosts and certificate secrets
### Details:
Extend templates/ingress.yaml with spec.tls configuration. Add ingress.tls array in values.yaml with entries containing secretName and hosts array. Support multiple TLS configurations for different host groups. Document TLS termination at ingress level vs passthrough to SpiceDB. For passthrough scenarios, document nginx annotation nginx.ingress.kubernetes.io/ssl-passthrough: "true". Include notes on certificate management (cert-manager integration recommended). Support empty tls array for non-TLS setups.

## 4. Create NetworkPolicy template with ingress rules [done]
### Dependencies: None
### Description: Implement templates/networkpolicy.yaml with ingress rules allowing traffic from ingress controller and inter-pod communication
### Details:
Create templates/networkpolicy.yaml with apiVersion networking.k8s.io/v1. Add podSelector matching SpiceDB deployment labels. Configure policyTypes: [Ingress, Egress]. Define ingress rules: allow traffic to port 50051 (gRPC) and 8443 (HTTP) from ingress controller namespace (using namespaceSelector with appropriate labels), allow traffic to port 50053 (dispatch) from same deployment pods (using podSelector). Add values.yaml: networkPolicy.enabled (default false), networkPolicy.ingress (array for custom rules), networkPolicy.ingressControllerNamespaceSelector for identifying ingress controller namespace.
<info added on 2025-11-08T14:52:36.812Z>
Successfully implemented NetworkPolicy template with comprehensive ingress and egress rules. Created templates/networkpolicy.yaml with ingress rules for gRPC (50051), HTTP (8443), metrics (9090), and dispatch (50053) ports. Configured namespace selectors for ingress controller and Prometheus integration. Added dispatch cluster communication support between SpiceDB pods and custom ingress rules array for extensibility. Updated values.yaml with networkPolicy section including enabled flag (default false), ingressControllerNamespaceSelector, prometheusNamespaceSelector, databaseEgress for custom database connection rules, and custom ingress/egress arrays. Updated values.schema.json with validation for all networkPolicy fields. Created comprehensive test suite with 7 scenarios verifying default disabled behavior, basic rendering, ingress controller integration, dispatch cluster communication, PostgreSQL egress rules, Prometheus integration, and schema validation. All tests pass successfully. NetworkPolicy follows Kubernetes best practices with zero-trust security model.
</info added on 2025-11-08T14:52:36.812Z>

## 5. Add NetworkPolicy egress rules for required connectivity [done]
### Dependencies: 9.4
### Description: Implement egress rules in NetworkPolicy allowing DNS resolution, datastore connectivity, and Kubernetes API access
### Details:
Extend templates/networkpolicy.yaml egress rules: allow DNS (port 53 UDP/TCP to kube-system namespace with k8s-app=kube-dns label), allow datastore connectivity (ports based on datastore type - PostgreSQL 5432, MySQL 3306, CockroachDB 26257), allow Kubernetes API access (port 443 to kubernetes service). Make egress rules configurable via networkPolicy.egress in values.yaml for custom rules. Support datastore-specific port configuration based on spicedb.config.datastoreEngine. Document egress rule requirements and security implications.
<info added on 2025-11-08T14:57:44.167Z>
Implementation completed. Egress rules extended with Kubernetes API server access (port 443 to default/component=apiserver), datastore-specific port auto-detection (PostgreSQL 5432, CockroachDB 26257, custom port support via config.datastore.port), all configurable via networkPolicy.databaseEgress. All 94 unit tests passing including 15 new NetworkPolicy-specific tests covering PostgreSQL/CockroachDB default and custom ports, memory datastore, dispatch egress, and custom configurations. Files modified: templates/networkpolicy.yaml, values.yaml, test-networkpolicy-values.yaml. Created: tests/unit/networkpolicy_test.yaml. Helm lint validation passed.
</info added on 2025-11-08T14:57:44.167Z>

## 6. Create controller-specific examples and integration tests [done]
### Dependencies: 9.3, 9.5
### Description: Create production examples for nginx and Contour ingress controllers with comprehensive integration tests validating Ingress and NetworkPolicy functionality
### Details:
Create examples/production-ingress-nginx.yaml with nginx-specific configuration: annotations for SSL redirect, proxy timeouts, backend protocol (GRPC), rate limiting. Create examples/production-ingress-contour.yaml with Contour-specific configuration: timeout policies, retry policies, TLS delegation. Document setup procedures for each controller type including installation and configuration. Document TLS termination options (at ingress vs passthrough) with examples for both. Document NetworkPolicy security benefits (network segmentation, blast radius reduction) and limitations (no L7 filtering, requires CNI support). Create integration tests deploying actual ingress controllers, verifying routing to SpiceDB services, validating TLS termination, testing NetworkPolicy enforcement.

